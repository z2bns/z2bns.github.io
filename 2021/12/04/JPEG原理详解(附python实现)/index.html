<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="JPEG（Joint Photographic Experts Group）是JPEG标准的产物，该标准由国际标准化组织（ISO）制订，是面向连续色调静止图像的一种压缩标准。 JPEG格式是最常用的图像文件格式，后缀名为.jpg或.jpeg。">
<meta property="og:type" content="article">
<meta property="og:title" content="JPEG原理详解(附python实现)">
<meta property="og:url" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/index.html">
<meta property="og:site_name" content="CTF of Z2BNS">
<meta property="og:description" content="JPEG（Joint Photographic Experts Group）是JPEG标准的产物，该标准由国际标准化组织（ISO）制订，是面向连续色调静止图像的一种压缩标准。 JPEG格式是最常用的图像文件格式，后缀名为.jpg或.jpeg。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/Lenna.png">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/jpeg_01.jpg">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_26.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_27.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_28.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_25.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_29.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_30.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_31.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_32.gif">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_33.gif">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="https://thecodeway.com/blog/wp-content/uploads/2014/09/github.gif">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="og:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现">
<meta property="article:published_time" content="2021-12-04T12:09:55.000Z">
<meta property="article:modified_time" content="2022-05-22T07:36:06.172Z">
<meta property="article:author" content="Z2BNS">
<meta property="article:tag" content="图像">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/Lenna.png">

<link rel="canonical" href="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>JPEG原理详解(附python实现) | CTF of Z2BNS</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CTF of Z2BNS</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-playlist">

    <a href="/playlist/" rel="section"><i class="fa fa-music fa-fw"></i>歌单</a>

  </li>
        <li class="menu-item menu-item-todolist">

    <a href="/todolist/" rel="section"><i class="fa fa-clipboard-list fa-fw"></i>愿望单</a>

  </li>
        <li class="menu-item menu-item-love">

    <a href="/love/" rel="section"><i class="fa fa-heart-fill fa-fw"></i>爱</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Z2BNS">
      <meta itemprop="description" content="Because like, so love">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CTF of Z2BNS">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JPEG原理详解(附python实现)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-04 20:09:55" itemprop="dateCreated datePublished" datetime="2021-12-04T20:09:55+08:00">2021-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-22 15:36:06" itemprop="dateModified" datetime="2022-05-22T15:36:06+08:00">2022-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%8D%E6%9D%82%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%9B%BE%E5%83%8F%E5%8A%A0%E5%AF%86/" itemprop="url" rel="index"><span itemprop="name">复杂网络与图像加密</span></a>
                </span>
            </span>
		  <div style="display:inline">
		   |
		  <i class="fa fa-eye"></i>
		  阅读次数：<span id="busuanzi_value_page_pv"></span> |
		  </div>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>JPEG（Joint Photographic Experts Group）是JPEG标准的产物，该标准由国际标准化组织（ISO）制订，是面向连续色调静止图像的一种压缩标准。 JPEG格式是最常用的图像文件格式，后缀名为.jpg或.jpeg。</p>
<a id="more"></a>
<h6 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h6><p>图片压缩有多重要，可能很多人可能并没有一个直观上的认识，举个例子，一张800X800大小的普通图片，如果未经压缩，大概在1.7MB左右，这个体积如果存放文本文件的话足够保存一部92万字的鸿篇巨著《红楼梦》，现如今互联网上绝大部分图片都使用了JPEG压缩技术，也就是大家使用的jpg文件，通常JPEG文件相对于原始图像,能够得到1/8的压缩比，如此高的压缩率是如何做到的呢？<br>    JPEG能够获得如此高的压缩比是因为使用了有损压缩技术，所谓有损压缩，就是把原始数据中不重要的部分去掉，以便可以用更小的体积保存，这个原理其实很常见，比如485194.200000000001这个数，如果我们用485194.2来保存，就是一种“有损”的保存方法，因为小数点后面的那个“0.000000000001”属于不重要的部分，所以可以被忽略掉。JPEG整个压缩过程基本上也是遵循这个步骤：</p>
<ol>
<li>把数据分为“重要部分”和“不重要部分”</li>
<li>滤掉不重要的部分</li>
<li>保存</li>
</ol>
<h6 id="步骤一：图像分割"><a href="#步骤一：图像分割" class="headerlink" title="步骤一：图像分割"></a>步骤一：图像分割</h6><p>JPEG算法的第一步，图像被分割成大小为8X8的小块，这些小块在整个压缩过程中都是单独被处理的。后面我们会以一张非常经典的图为例，这张图片名字叫做Lenna，据说是世界上第一张JPG图片，这张图片自从诞生之日开始，就和图像处理结下渊源，陪伴了无数理工宅男度过了的一个个不眠之夜，可谓功勋卓著，感兴趣的朋友可以在这里了解到这张图片的故事。</p>
<div align="center">
    <img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/Lenna.png">
        <img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/jpeg_01.jpg">  
    
</div>





<h6 id="步骤二：颜色空间转换RGB-gt-YCbCr"><a href="#步骤二：颜色空间转换RGB-gt-YCbCr" class="headerlink" title="步骤二：颜色空间转换RGB-&gt;YCbCr"></a>步骤二：颜色空间转换RGB-&gt;YCbCr</h6><p>所谓“颜色空间”，是指表达颜色的数学模型，比如我们常见的“RGB”模型，就是把颜色分解成红绿蓝三种分量，这样一张图片就可以分解成三张灰度图，数学表达上，每一个8X8的图案，可以表达成三个8X8的矩阵，其中的数值的范围一般在[0,255]之间</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>R</th>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_03.jpg)</th>
<th>&gt;</th>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_06.gif)</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_02.jpg)</td>
<td><strong>G</strong></td>
<td><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_05.jpg)</td>
<td>&gt;</td>
<td><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_08.gif)</td>
</tr>
<tr>
<td></td>
<td><strong>B</strong></td>
<td><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_04.jpg)</td>
<td>&gt;</td>
<td><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="img">/jpeg_07.gif)</td>
</tr>
</tbody>
</table>
</div>
<p>不同的颜色模型各有不同的应用场景，例如RGB模型适合于像显示器这样的自发光图案，而在印刷行业，使用油墨打印，图案的颜色是通过在反射光线时产生的，通常使用CMYK模型，而在JPEG压缩算法中，需要把图案转换成为YCbCr模型，这里的Y表示亮度(Luminance)，Cb和Cr分别表示绿色和红色的“色差值”。<br>    “色差”这个概念起源于电视行业，最早的电视都是黑白的，那时候传输电视信号只需要传输亮度信号，也就是Y信号即可，彩色电视出现之后，人们在Y信号之外增加了两条色差信号以传输颜色信息，这么做的目的是为了兼容黑白电视机，因为黑白电视只需要处理信号中的Y信号即可。<br>    根据三基色原理，人们发现红绿蓝三种颜色所贡献的亮度是不同的，绿色的“亮度”最大，蓝色最暗，设红色所贡献的亮度的份额为KR，蓝色贡献的份额为KB，那么亮度为</p>
<script type="math/tex; mode=display">
Y=K_R·R+(1-K_R-K_B)·G+K_B·B</script><p>根据经验，KR=0.299,KB=0.114,那么</p>
<script type="math/tex; mode=display">
Y=0.299·R+0.587·G+0.114·B</script><p>蓝色和红色的色差的定义如下：</p>
<script type="math/tex; mode=display">
C_b=\frac{1}{2}·\frac{B-Y}{1-K_B}</script><script type="math/tex; mode=display">
C_r=\frac{1}{2}·\frac{R-Y}{1-K_R}</script><p>最终可以得到RGB转换为YCbCr的数学公式为：</p>
<script type="math/tex; mode=display">
Y=0.299·R+0.5870·G+0.114·B\\
C_b=-0.1687·R-0.3313·G+0.5·B\\
C_r=0.5·R-0.4187·G-0.0813·B</script><p>YCbCr模型广泛应用在图像和视频的压缩传输中，比如你可以留意一下电视或者DVD后面的接口，就可以发现色差接口。</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_14">/jpeg_14.jpg)</p>
<p>这是有道理的，还记得我们在文章开始时提到的有损压缩的基本原理吗？有损压缩首先要做的事情就是“把重要的信息和不重要的信息分开”，YCbCr恰好能做到这一点。对于人眼来说，图像中明暗的变化更容易被感知到，这是由于人眼的构造引起的。视网膜上有两种感光细胞，能够感知亮度变化的视杆细胞，以及能够感知颜色的视锥细胞，由于视杆细胞在数量上远大于视锥细胞，所以我们更容易感知到明暗细节。比如说下面这张图</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_15">/jpeg_15.jpg)</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_16">/jpeg_16.jpg)</th>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_17">/jpeg_17.jpg)</th>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_18">/jpeg_18.jpg)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Y</td>
<td>Cb</td>
<td>Cr</td>
</tr>
</tbody>
</table>
</div>
<p>可以明显看到，亮度图的细节更加丰富。JPEG把图像转换为YCbCr之后，就可以针对数据得重要程度的不同做不同的处理。这就是为什么JPEG使用这种颜色空间的原因。</p>
<h6 id="步骤三：离散余弦变换"><a href="#步骤三：离散余弦变换" class="headerlink" title="步骤三：离散余弦变换"></a>步骤三：离散余弦变换</h6><p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_20">/jpeg_20.jpg)</p>
<p>​    这次我们来介绍JPEG算法中的核心内容，离散余弦变换（Discrete cosine transform），简称DCT。<br>​    离散余弦变换属于傅里叶变换的另外一种形式，没错，就是大名鼎鼎的傅里叶变换。傅里叶是法国著名的数学家和物理学家，1807年，39岁的傅里叶在他的一篇论文里提出了一个想法，他认为<strong>任何周期性的函数，都可以分解为为一系列的三角函数的组合</strong>，这个想法一开始并没有得到当时科学界的承认，比如当时著名的数学家拉格朗日提出质疑，三角函数无论如何组合，都无法表达带有“尖角”的函数，一直到1822年拉格朗日死后，傅里叶的想法才正式在他的著作《热的解析理论》一书中正式发表。<br>​    金子总会闪光，傅里叶变换如今广泛应用于数学、物理、信号处理等等领域，变换除了它在数学上的意义外，还有其哲学上的伟大意义，那就是，世上任何复杂的事物，都可以分解为简单的事物的组合，而这个过程只需要借助数学工具就可以了。但是当年拉格朗日的质疑是正确的，三角函数的确无法表达出尖角形状的函数，不过只要三角函数足够多，可以无限逼近最终结果。比如下面这张动图，就动态描述了一个矩形方波，是如何做傅里叶分析的。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_22">/jpeg_22.jpg)</th>
<th><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_21">/jpeg_21.gif)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>当我们要处理的不再是函数，而是一堆离散的数据时，并且这些数据是对称的话，那么傅里叶变化出来的函数只含有余弦项，这种变换称为离散余弦变换。举个例子，有一组一维数据[x0,x1,x2,…,xn-1],那么可以通过DCT变换得到n个变换级数Fi</p>
<script type="math/tex; mode=display">
F_m=\sum^{n-1}_{k=0}{x_kcos[\frac{\pi}{n}m(k+\frac{1}{2})]} ,m=0,1,...,n-1</script><p>此时原始数据Xi可以通过离散余弦变换变化的逆变换（IDCT）表达出来</p>
<script type="math/tex; mode=display">
X_m=\frac{F_0}{n}+\sum^{n-1}_{k=1}{[\frac{2F_k}{n}cos[\frac{\pi}{n}(m+\frac{1}{2})k]]}</script><p>也就是说，经过DCT变换，可以把一个数组分解成数个数组的和，如果我们数组视为一个一维矩阵，那么可以把结果看做是一系列矩阵的和</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_24">/jpeg_24.gif)</p>
<p>举个例子，我们有一个长度为8的数字，内容为50,55,67,80,-10,-5,20,30，经过DCT转换，得到8个级数为287.0,106.3,14.2,-110.8,9.2,65.7,-8.2,-43.9，根据公式2.3把这个数组转换为8个新的数组的和，如果我们使用图像来表达的话，就可以发现DCT转换的有趣之处了</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:right"></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right"></td>
<td>数组0</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_26.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[35.9,35.9,35.9,35.9,35.9,35.9,35.9,35.9]</td>
</tr>
<tr>
<td style="text-align:right"></td>
<td>数组1</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_27.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[26.0,22.1,14.8,5.2,-5.2,-14.8,-22.1,-26.1]</td>
</tr>
<tr>
<td style="text-align:right"></td>
<td>数组2</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_28.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[3.3,1.4,-1.4,-3.3,-3.3,-1.4,1.4,3.3]</td>
</tr>
<tr>
<td style="text-align:right"><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_25.gif" alt="img"></td>
<td>数组3</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_29.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right">[50,55,67,80,-10,-5,20,30]</td>
<td></td>
<td>[-23.0,5.4,27.2,15.4,-15.4,-27.2,-5.4,23.0]</td>
</tr>
<tr>
<td style="text-align:right"></td>
<td>数组4</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_30.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[1.6,-1.6,-1.6,1.6,1.6,-1.6,-1.6,1.6]</td>
</tr>
<tr>
<td style="text-align:right"></td>
<td>数组5</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_31.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[9.1,-16.1,3.2,13.6,-13.6,-3.2,16.1,-9.1]</td>
</tr>
<tr>
<td style="text-align:right"></td>
<td>数组6</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_32.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[-0.8,1.9,-1.9,0.8,0.8,-1.9,1.9,-0.8]</td>
</tr>
<tr>
<td style="text-align:right"></td>
<td>数组7</td>
<td><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/jpeg_33.gif" alt="img"></td>
</tr>
<tr>
<td style="text-align:right"></td>
<td></td>
<td>[-2.1,6.1,-9.1,10.8,-10.8,9.1,-6.1,2.1]</td>
</tr>
</tbody>
</table>
</div>
<p>奥妙之处在于，经过DCT，数据中隐藏的规律被发掘了出来,杂乱的数据被转换成几个工整变化的数据。DCT转换后的数组中第一个是一个直线数据，因此又被称为“直流数据”，简称DC，后面的数据被称为“交流数据”，简称AC，这个称呼起源于信号分析中的术语。<br>    在JPEG压缩过程中，经过颜色空间的转换，每一个8X8的图像块，在数据上表现为3个8X8的矩阵，紧接着我们对这三个矩阵做一个二维的DCT转换，二维的DCT转换公式为</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_34">/jpeg_34.gif)</p>
<p>DCT的威力究竟有多大，我们可以做一个实际的测试，比如一个所有数值都一样的矩阵，经过DCT转换后，将所有级数组合成一个新的矩阵</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_35">/jpeg_35.gif)</p>
<p>可以看到，经过DCT转换，矩阵的“能量”被全部集中在左上角上的直流分量F(0,0）上，其他位置都变成了0。<br>    在实际的JPEG压缩过程中，由于图像本身的连贯性，一个8X8的图像中的数值一般不会出现大的跳跃，经过DCT转换会有类似的效果，左上角的直流分量保存了一个大的数值，其他分量都接近于0，我们以Lenna左上角第一块图像的Y分量为例，经过变换的矩阵为</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_36">/jpeg_36.gif)</p>
<p>可以看到，数据经过DCT变化后，被明显分成了直流分量和交流分量两部分，为后面的进一步压缩起到了充分的铺垫作用，可以说是整个JPEG中最重要的一步，后面我们会介绍数据量化。</p>
<h6 id="步骤四：数据量化"><a href="#步骤四：数据量化" class="headerlink" title="步骤四：数据量化"></a>步骤四：数据量化</h6><p>经过上一节介绍的离散余弦变换，图像数据虽然已经面目全非，但仍然是处于“可逆”的状态，也就是说我们还没有进入“有损”的那一步。这次我们来玩真的，看一下数据中的细节是如何被滤去的。先来考察一下要对付的问题是什么，经过颜色空间转换和离散余弦变换，每一个8X8的图像块都变成了三个8X8的浮点数矩阵，分别表示Y,Cr,Cb数据，比如以其中某个亮度数据矩阵举例，它的数据如下</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_030">/jpeg_030.gif)</p>
<p>我们的问题是，在可以损失一部分精度的情况下，如何用更少的空间存储这些浮点数？答案是使用量子化（Quantization），简称量化。“量子”这个概念来自于物理学，意思是说连续的能量可以看做是一个个单元体的组合，看起来高端大气，其实很简单，比如游戏中在处理角色面朝方向时，一般并不是使用0到2π这样的浮点数，而是把方向分成16个区间，用0到16这样的整数来表示，这样只用4个bit就足够了。JPEG提供的量子化算法如下：</p>
<script type="math/tex; mode=display">
B_{i,j}=round(\frac{G_{i,j}}{Q_{i,j}});i,j=0,1,2,...,7</script><p>其中G是我们需要处理的图像矩阵，Q称作量化系数矩阵（Quantization matrices），JPEG算法提供了两张标准的量化系数矩阵，分别用于处理亮度数据Y和色差数据Cr以及Cb。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_032">/jpeg_032.gif)</th>
<th style="text-align:center"><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_033">/jpeg_033.gif)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">标准亮度量化表</td>
<td style="text-align:center">标准色差量化表</td>
</tr>
</tbody>
</table>
</div>
<p>其中round函数是取整函数，但考虑到了四舍五入，也就是说</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_035">/jpeg_035.gif)</p>
<p>比如上面数据，以左上角的-415.38为例，对应的量子化系数是16，那么round(-415.38/16)=round(-25.96125)=-26。最终得到的量子化后的结果为</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_034">/jpeg_034.gif)</p>
<p>可以看到，一大部分数据变成了0，这非常有利于后面的压缩存储。这两张神奇的量化表也是有讲究的，还记得我们在第一节中所讲的有损压缩的基本原理吗，有损压缩就是把数据中重要的数据和不重要的数据分开，然后分别处理。DCT系数矩阵中的不同位置的值代表了图像数据中不同频率的分量，这两张表中的数据时人们根据人眼对不不同频率的敏感程度的差别所积累下的经验制定的，一般来说人眼对于低频的分量比高频分量更加敏感，所以两张量化系数矩阵左上角的数值明显小于右下角区域。在实际的压缩过程中，还可以根据需要在这些系数的基础上再乘以一个系数，以使更多或更少的数据变成0，我们平时使用的图像处理软件在生成jpg文件时，在控制压缩质量的时候，就是控制的这个系数。<br>    在进入下一节之前，矩阵的量化还有最后一步要做，就是把量化后的二维矩阵转变成一个一维数组，以方便后面的霍夫曼压缩，但在做这个顺序转换时，需要按照一个特定的取值顺序。</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="jpeg_036">/jpeg_036.gif)</p>
<p>这么做的目的只有一个，就是尽可能把0放在一起，由于0大部分集中在右下角，所以才去这种由左上角到右下角的顺序，经过这种顺序变换，最终矩阵变成一个整数数组</p>
<p>-26,-3,0,-3,-2,-6,2,-4,1,-3,0,1,5,,1,2,-1,1,-1,2,0,0,0,0,0,-1,-1,0,0,0,0,…,0,0</p>
<p>后面的工作就是对这个数组进行再一次的哈夫曼压缩，已得到最终的压缩数据。</p>
<h6 id="步骤五：哈夫曼编码"><a href="#步骤五：哈夫曼编码" class="headerlink" title="步骤五：哈夫曼编码"></a>步骤五：哈夫曼编码</h6><p>JPEG压缩的最后一步是对数据进行哈弗曼编码(Huffman coding)，哈弗曼几乎是所有压缩算法的基础，它的基本原理是根据数据中元素的使用频率，调整元素的编码长度，以得到更高的压缩比。<br>    举个例子，比如下面这段数据</p>
<p>“AABCBABBCDBBDDBAABDBBDABBBBDDEDBD”</p>
<p> 这段数据里面包含了33个字符，每种字符出现的次数统计如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>字符</strong></th>
<th><strong>A</strong></th>
<th><strong>B</strong></th>
<th><strong>C</strong></th>
<th><strong>D</strong></th>
<th><strong>E</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>次数</td>
<td>6</td>
<td>15</td>
<td>2</td>
<td>9</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p>如果我们用我们常见的定长编码，每个字符都是3个bit。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>字符</strong></th>
<th><strong>A</strong></th>
<th><strong>B</strong></th>
<th><strong>C</strong></th>
<th><strong>D</strong></th>
<th><strong>E</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>编码</td>
<td>001</td>
<td>010</td>
<td>011</td>
<td>100</td>
<td>101</td>
</tr>
</tbody>
</table>
</div>
<p>那么这段文字共需要3*33 = 99个bit来保存，但如果我们根据字符出现的概率，使用如下的编码</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>字符</strong></th>
<th><strong>A</strong></th>
<th><strong>B</strong></th>
<th><strong>C</strong></th>
<th><strong>D</strong></th>
<th><strong>E</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>编码</td>
<td>110</td>
<td>0</td>
<td>1110</td>
<td>10</td>
<td>1111</td>
</tr>
</tbody>
</table>
</div>
<p>那么这段文字共需要3<em>6 + 1</em>15 + 4<em>2 + 2</em>9 + 4*1 = 63个bit来保存，压缩比为63%，哈弗曼编码一般都是使用二叉树来生成的，这样得到的编码符合前缀规则，也就是较短的编码不能够是较长编码的前缀，比如上面这个编码，就是由下面的这颗二叉树生成的。</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="hufman7">/hufman7.gif)</p>
<p>我们回到JPEG压缩上，回顾上一节的内容，经过数据量化，我们现在要处理的数据是一串一维数组，举例如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>①原始数据</strong></th>
<th>35,7,0,0,0,-6,-2,0,0,-9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,0,…,0</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>在实际的压缩过程中，数据中的0出现的概率非常高，所以首先要做的事情，是对其中的0进行处理，把数据中的非零的数据，以及数据前面0的个数作为一个处理单元。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>①原始数据</th>
<th>35,7,0,0,0,-6,-2,0,0,-9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,0,…,0</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>②RLE编码</strong></td>
<td>35</td>
<td>7</td>
<td>0,0,0,-6</td>
<td>-2</td>
<td>0,0,-9</td>
<td>0,0,…,0,8</td>
<td>0,0,…,0</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>①原始数据</th>
<th style="text-align:center">35,7,0,0,0,-6,-2,0,0,-9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,0,…,0</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>②RLE编码</strong></th>
<th>35</th>
<th>7</th>
<th>0,0,0,-6</th>
<th>-2</th>
<th>0,0,-9</th>
<th>0,0,…,0,8</th>
<th>0,0,…,0</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>如果其中某个单元的0的个数超过16，则需要分成每16个一组，如果最后一个单元全都是0，则使用特殊字符“EOB”表示，EOB意思就是“后面的数据全都是0”,</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>①原始数据</th>
<th style="text-align:center">35,7,0,0,0,-6,-2,0,0,-9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,0,…,0</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>②RLE编码</strong></th>
<th>35</th>
<th>7</th>
<th>0,0,0,-6</th>
<th>-2</th>
<th>0,0,-9</th>
<th>0,0,…,0,8</th>
<th>0,0,…,0</th>
</tr>
</thead>
<tbody>
<tr>
<td>35</td>
<td>7</td>
<td>0,0,0,-6</td>
<td>-2</td>
<td>0,0,-9</td>
<td>0,0,…,0</td>
<td>0,0,8</td>
<td>0,0,…,0</td>
</tr>
<tr>
<td>(0,35)</td>
<td>(0,7)</td>
<td>(3,-6)</td>
<td>(0,-2)</td>
<td>(2,-9)</td>
<td>(15,0)</td>
<td>(2,8)</td>
<td>EOB</td>
</tr>
</tbody>
</table>
</div>
<p>其中（15,0）表示16个0，接下来我们要处理的是括号里右面的数字，这个数字的取值范围在-2047~2047之间，JPEG提供了一张标准的码表用于对这些数字编码：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Value</th>
<th>Size</th>
<th>Bits</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>–</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>-3,-2</td>
<td>2,3</td>
<td>2</td>
<td>00,01</td>
<td>10,11</td>
</tr>
<tr>
<td>-7,-6,-5,-4</td>
<td>4,5,6,7</td>
<td>3</td>
<td>000,001,010,011</td>
<td>100,101,110,111</td>
</tr>
<tr>
<td>-15,…,-8</td>
<td>8,…,15</td>
<td>4</td>
<td>0000,…,0111</td>
<td>1000,…,1111</td>
</tr>
<tr>
<td>-31,…,-16</td>
<td>16,…,31</td>
<td>5</td>
<td>0 0000,…,0 1111</td>
<td>1 0000,…,1 1111</td>
</tr>
<tr>
<td>-63,…,-32</td>
<td>32,…,63</td>
<td>6</td>
<td>00 0000,…</td>
<td>…,11 1111</td>
</tr>
<tr>
<td>-127,…,-64</td>
<td>64,…,127</td>
<td>7</td>
<td>000 0000,…</td>
<td>…,111 1111</td>
</tr>
<tr>
<td>-255,…,-128</td>
<td>128,…,255</td>
<td>8</td>
<td>0000 0000,…</td>
<td>…,1111 1111</td>
</tr>
<tr>
<td>-511,…,-256</td>
<td>256,…,511</td>
<td>9</td>
<td>0 0000 0000,…</td>
<td>…,1 1111 1111</td>
</tr>
<tr>
<td>-1023,…,-512</td>
<td>512,…,1023</td>
<td>10</td>
<td>00 0000 0000,…</td>
<td>…,11 1111 1111</td>
</tr>
<tr>
<td>-2047,…,-1024</td>
<td>1024,…,2047</td>
<td>11</td>
<td>000 0000 0000,…</td>
<td>…,111 1111 1111</td>
</tr>
</tbody>
</table>
</div>
<p>举例来说，第一个单元中的“35”这个数字，在表中的位置是长度为6的那组，所对应的bit码是“100011”，而“-6”的编码是”001″，由于这种编码附带长度信息，所以我们的数据变成了如下的格式。</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="image-20211204214416786">/image-20211204214416786.png)</p>
<p>括号中前两个数字分都在0~15之间，所以这两个数可以合并成一个byte，高四位是前面0的个数，后四位是后面数字的位数。</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="image-20211204214450657">/image-20211204214450657.png)</p>
<p>对于括号前面的数字的编码，就要使用到我们提到的哈弗曼编码了，比如下面这张表，就是一张针对数据中的第一个单元，也就是直流(DC)部分的哈弗曼表，由于直流部分没有前置的0，所以取值范围在0~15之间。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Length</th>
<th>Value</th>
<th>Bits</th>
</tr>
</thead>
<tbody>
<tr>
<td>3 bits</td>
<td>04 <br>05<br> 03 <br>02 <br>06 <br>01 <br>00 (EOB)</td>
<td>000 <br>001<br> 010<br> 011<br> 100 <br>101 <br>110</td>
</tr>
<tr>
<td>4 bits</td>
<td>07</td>
<td>1110</td>
</tr>
<tr>
<td>5 bits</td>
<td>08</td>
<td>1111 0</td>
</tr>
<tr>
<td>6 bits</td>
<td>09</td>
<td>1111 10</td>
</tr>
<tr>
<td>7 bits</td>
<td>0A</td>
<td>1111 110</td>
</tr>
<tr>
<td>8 bits</td>
<td>0B</td>
<td>1111 1110</td>
</tr>
</tbody>
</table>
</div>
<p>举例来说，示例中的DC部分的数据是0x06，对应的二进制编码是“100”，而对于后面的交流部分，取值范围在0~255之间，所以对应的哈弗曼表会更大一些</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Length</th>
<th>Value</th>
<th>Bits</th>
</tr>
</thead>
<tbody>
<tr>
<td>2 bits</td>
<td>01<br> 02</td>
<td>00 <br>01</td>
</tr>
<tr>
<td>3 bits</td>
<td>03</td>
<td>100</td>
</tr>
<tr>
<td>4 bits</td>
<td>00 (EOB)<br> 04 <br>11</td>
<td>1010 <br>1011 <br>1100</td>
</tr>
<tr>
<td>5 bits</td>
<td>05 <br>12 <br>21</td>
<td>1101 0 <br>1101 1 <br>1110 0</td>
</tr>
<tr>
<td>6 bits</td>
<td>31 <br>41</td>
<td>1110 10<br> 1110 11</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>12 bits</td>
<td>24<br> 33 <br>62 <br>72</td>
<td>1111 1111 0100<br> 1111 1111 0101<br> 1111 1111 0110 <br>1111 1111 0111</td>
</tr>
<tr>
<td>15 bits</td>
<td>82</td>
<td>1111 1111 1000 000</td>
</tr>
<tr>
<td>16 bits</td>
<td>09<br> …<br> FA</td>
<td>1111 1111 1000 0010 <br>… <br>1111 1111 1111 1110</td>
</tr>
</tbody>
</table>
</div>
<p>这样经过哈弗曼编码，并且序列化后，最终数据成为如下形式</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="image-20211204214722661">/image-20211204214722661.png)</p>
<p>最终我们使用了10个字节的空间保存了原本长度为64的数组，至此JPEG的主要压缩算法结束，这些数据就是保存在jpg文件中的最终数据。</p>
<p>这个系列的最后，我提供给大家一个简易的jpeg压缩算法的代码，这份代码用C++编写，以开源方式提供，放在了github上，可以到下面这个网址下载</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><img src="https://thecodeway.com/blog/wp-content/uploads/2014/09/github.gif" alt="img"></th>
<th><a target="_blank" rel="noopener" href="http://github.com/thejinchao/jpeg_encoder">http://github.com/thejinchao/jpeg_encoder</a></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>使用方法很简单，像下面这样就可以了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;jpeg_encoder.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">JpegEncoder encoder;</span><br><span class="line"><span class="comment">//输入的文件必须是24bit的bmp文件，尺寸必须是8的倍数</span></span><br><span class="line">encoder.readFromBMP(inputFileName);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//第二个参数在1~199之间，代表文件压缩程度，数字越大，压缩后的文件体积越小</span></span><br><span class="line">encoder.encodeToJPG(outputFileName, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>
<p>这份代码只是为了配合这个系列的文章，所以没有考虑优化，如果你想在实际工程中使用jpeg的压缩算法，还是使用被广泛应用的<a target="_blank" rel="noopener" href="http://www.ijg.org/">libjpeg</a>或者<a target="_blank" rel="noopener" href="http://www.openjpeg.org/">OpenJpeg</a>。</p>
<h6 id="转载"><a href="#转载" class="headerlink" title="转载"></a>转载</h6><p>以上内容转载自以下链接</p>
<p><strong><a target="_blank" rel="noopener" href="https://thecodeway.com/blog/?p=69">https://thecodeway.com/blog/?p=69</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://thecodeway.com/blog/?p=353">https://thecodeway.com/blog/?p=353</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://thecodeway.com/blog/?p=480">https://thecodeway.com/blog/?p=480</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://thecodeway.com/blog/?p=522">https://thecodeway.com/blog/?p=522</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://thecodeway.com/blog/?p=690">https://thecodeway.com/blog/?p=690</a></strong></p>
<h6 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h6><p>这里以大小为512*512的lena灰度图像为例，进行jpeg图像压缩及解压缩举例，lena灰度图如下</p>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="lena">/lena.jpg)</p>
<h6 id="python代码"><a href="#python代码" class="headerlink" title="python代码"></a>python代码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pyblake2 <span class="keyword">import</span> blake2s</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">jpeg压缩函数</span></span><br><span class="line"><span class="string">data:要压缩的灰度图像数据流</span></span><br><span class="line"><span class="string">quality_scale控制压缩质量(1-99)，默认为50，值越小图像约清晰</span></span><br><span class="line"><span class="string">return:得到压缩后的图像数据，为FFD9开头的jpeg格式字符串</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compress</span>(<span class="params">img_data,quality_scale=<span class="number">50</span></span>):</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#获取图像数据流宽高</span></span><br><span class="line">  h,w=img_data.shape</span><br><span class="line">  <span class="comment">#标准亮度量化表</span></span><br><span class="line">  Qy=np.array([[<span class="number">16</span>,<span class="number">11</span>,<span class="number">10</span>,<span class="number">16</span>,<span class="number">24</span>,<span class="number">40</span>,<span class="number">51</span>,<span class="number">61</span>],</span><br><span class="line">  	[<span class="number">12</span>,<span class="number">12</span>,<span class="number">14</span>,<span class="number">19</span>,<span class="number">26</span>,<span class="number">58</span>,<span class="number">60</span>,<span class="number">55</span>],</span><br><span class="line">  	[<span class="number">14</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">24</span>,<span class="number">40</span>,<span class="number">57</span>,<span class="number">69</span>,<span class="number">56</span>],</span><br><span class="line">  	[<span class="number">14</span>,<span class="number">17</span>,<span class="number">22</span>,<span class="number">29</span>,<span class="number">51</span>,<span class="number">87</span>,<span class="number">80</span>,<span class="number">62</span>],</span><br><span class="line">  	[<span class="number">18</span>,<span class="number">22</span>,<span class="number">37</span>,<span class="number">56</span>,<span class="number">68</span>,<span class="number">109</span>,<span class="number">103</span>,<span class="number">77</span>],</span><br><span class="line">  	[<span class="number">24</span>,<span class="number">35</span>,<span class="number">55</span>,<span class="number">64</span>,<span class="number">81</span>,<span class="number">104</span>,<span class="number">113</span>,<span class="number">92</span>],</span><br><span class="line">  	[<span class="number">49</span>,<span class="number">64</span>,<span class="number">78</span>,<span class="number">87</span>,<span class="number">103</span>,<span class="number">121</span>,<span class="number">120</span>,<span class="number">101</span>],</span><br><span class="line">  	[<span class="number">72</span>,<span class="number">92</span>,<span class="number">95</span>,<span class="number">98</span>,<span class="number">112</span>,<span class="number">100</span>,<span class="number">103</span>,<span class="number">99</span>]],dtype=np.uint8)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">#根据压缩质量重新计算量化表</span></span><br><span class="line">  <span class="keyword">if</span> quality_scale&lt;=<span class="number">0</span>:</span><br><span class="line">  	quality_scale=<span class="number">1</span></span><br><span class="line">  <span class="keyword">elif</span> quality_scale&gt;=<span class="number">100</span>:</span><br><span class="line">  	quality_scale=<span class="number">99</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  	tmp=int((Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]*quality_scale+<span class="number">50</span>)/<span class="number">100</span>)</span><br><span class="line">  	<span class="keyword">if</span> tmp&lt;=<span class="number">0</span>:</span><br><span class="line">  		tmp=<span class="number">1</span></span><br><span class="line">  	<span class="keyword">elif</span> tmp&gt;<span class="number">255</span>:</span><br><span class="line">  		tmp=<span class="number">255</span></span><br><span class="line">  	Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]=tmp</span><br><span class="line"></span><br><span class="line">  <span class="comment">#Z字型</span></span><br><span class="line">  ZigZag =[</span><br><span class="line">	<span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">27</span>,<span class="number">28</span>,</span><br><span class="line">	<span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">26</span>,<span class="number">29</span>,<span class="number">42</span>,</span><br><span class="line">	<span class="number">3</span>, <span class="number">8</span>,<span class="number">12</span>,<span class="number">17</span>,<span class="number">25</span>,<span class="number">30</span>,<span class="number">41</span>,<span class="number">43</span>,</span><br><span class="line">	<span class="number">9</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">24</span>,<span class="number">31</span>,<span class="number">40</span>,<span class="number">44</span>,<span class="number">53</span>,</span><br><span class="line">	<span class="number">10</span>,<span class="number">19</span>,<span class="number">23</span>,<span class="number">32</span>,<span class="number">39</span>,<span class="number">45</span>,<span class="number">52</span>,<span class="number">54</span>,</span><br><span class="line">	<span class="number">20</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">38</span>,<span class="number">46</span>,<span class="number">51</span>,<span class="number">55</span>,<span class="number">60</span>,</span><br><span class="line">	<span class="number">21</span>,<span class="number">34</span>,<span class="number">37</span>,<span class="number">47</span>,<span class="number">50</span>,<span class="number">56</span>,<span class="number">59</span>,<span class="number">61</span>,</span><br><span class="line">	<span class="number">35</span>,<span class="number">36</span>,<span class="number">48</span>,<span class="number">49</span>,<span class="number">57</span>,<span class="number">58</span>,<span class="number">62</span>,<span class="number">63</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">#DC哈夫曼编码表</span></span><br><span class="line">  standard_dc_nrcodes=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">  standard_dc_values=[<span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>]</span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  dc_huffman_table=[<span class="number">0</span>]*<span class="number">16</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_dc_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">      dc_huffman_table[standard_dc_values[pos_in_table]]=bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">      <span class="comment"># ac_huffman_table[standard_ac_values[pos_in_table]].length=k</span></span><br><span class="line">      pos_in_table+=<span class="number">1</span></span><br><span class="line">      code_value+=<span class="number">1</span></span><br><span class="line">    code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#AC哈夫曼编码表</span></span><br><span class="line"></span><br><span class="line">  standard_ac_nrcodes=[<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x7d</span>]</span><br><span class="line">  standard_ac_values=[<span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x11</span>, <span class="number">0x05</span>, <span class="number">0x12</span>,</span><br><span class="line">				<span class="number">0x21</span>, <span class="number">0x31</span>, <span class="number">0x41</span>, <span class="number">0x06</span>, <span class="number">0x13</span>, <span class="number">0x51</span>, <span class="number">0x61</span>, <span class="number">0x07</span>,</span><br><span class="line">				<span class="number">0x22</span>, <span class="number">0x71</span>, <span class="number">0x14</span>, <span class="number">0x32</span>, <span class="number">0x81</span>, <span class="number">0x91</span>, <span class="number">0xa1</span>, <span class="number">0x08</span>,</span><br><span class="line">				<span class="number">0x23</span>, <span class="number">0x42</span>, <span class="number">0xb1</span>, <span class="number">0xc1</span>, <span class="number">0x15</span>, <span class="number">0x52</span>, <span class="number">0xd1</span>, <span class="number">0xf0</span>,</span><br><span class="line">				<span class="number">0x24</span>, <span class="number">0x33</span>, <span class="number">0x62</span>, <span class="number">0x72</span>, <span class="number">0x82</span>, <span class="number">0x09</span>, <span class="number">0x0a</span>, <span class="number">0x16</span>,</span><br><span class="line">				<span class="number">0x17</span>, <span class="number">0x18</span>, <span class="number">0x19</span>, <span class="number">0x1a</span>, <span class="number">0x25</span>, <span class="number">0x26</span>, <span class="number">0x27</span>, <span class="number">0x28</span>,</span><br><span class="line">				<span class="number">0x29</span>, <span class="number">0x2a</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>, <span class="number">0x37</span>, <span class="number">0x38</span>, <span class="number">0x39</span>,</span><br><span class="line">				<span class="number">0x3a</span>, <span class="number">0x43</span>, <span class="number">0x44</span>, <span class="number">0x45</span>, <span class="number">0x46</span>, <span class="number">0x47</span>, <span class="number">0x48</span>, <span class="number">0x49</span>,</span><br><span class="line">				<span class="number">0x4a</span>, <span class="number">0x53</span>, <span class="number">0x54</span>, <span class="number">0x55</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x58</span>, <span class="number">0x59</span>,</span><br><span class="line">				<span class="number">0x5a</span>, <span class="number">0x63</span>, <span class="number">0x64</span>, <span class="number">0x65</span>, <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0x68</span>, <span class="number">0x69</span>,</span><br><span class="line">				<span class="number">0x6a</span>, <span class="number">0x73</span>, <span class="number">0x74</span>, <span class="number">0x75</span>, <span class="number">0x76</span>, <span class="number">0x77</span>, <span class="number">0x78</span>, <span class="number">0x79</span>,</span><br><span class="line">				<span class="number">0x7a</span>, <span class="number">0x83</span>, <span class="number">0x84</span>, <span class="number">0x85</span>, <span class="number">0x86</span>, <span class="number">0x87</span>, <span class="number">0x88</span>, <span class="number">0x89</span>,</span><br><span class="line">				<span class="number">0x8a</span>, <span class="number">0x92</span>, <span class="number">0x93</span>, <span class="number">0x94</span>, <span class="number">0x95</span>, <span class="number">0x96</span>, <span class="number">0x97</span>, <span class="number">0x98</span>,</span><br><span class="line">				<span class="number">0x99</span>, <span class="number">0x9a</span>, <span class="number">0xa2</span>, <span class="number">0xa3</span>, <span class="number">0xa4</span>, <span class="number">0xa5</span>, <span class="number">0xa6</span>, <span class="number">0xa7</span>,</span><br><span class="line">				<span class="number">0xa8</span>, <span class="number">0xa9</span>, <span class="number">0xaa</span>, <span class="number">0xb2</span>, <span class="number">0xb3</span>, <span class="number">0xb4</span>, <span class="number">0xb5</span>, <span class="number">0xb6</span>,</span><br><span class="line">				<span class="number">0xb7</span>, <span class="number">0xb8</span>, <span class="number">0xb9</span>, <span class="number">0xba</span>, <span class="number">0xc2</span>, <span class="number">0xc3</span>, <span class="number">0xc4</span>, <span class="number">0xc5</span>,</span><br><span class="line">				<span class="number">0xc6</span>, <span class="number">0xc7</span>, <span class="number">0xc8</span>, <span class="number">0xc9</span>, <span class="number">0xca</span>, <span class="number">0xd2</span>, <span class="number">0xd3</span>, <span class="number">0xd4</span>,</span><br><span class="line">				<span class="number">0xd5</span>, <span class="number">0xd6</span>, <span class="number">0xd7</span>, <span class="number">0xd8</span>, <span class="number">0xd9</span>, <span class="number">0xda</span>, <span class="number">0xe1</span>, <span class="number">0xe2</span>,</span><br><span class="line">				<span class="number">0xe3</span>, <span class="number">0xe4</span>, <span class="number">0xe5</span>, <span class="number">0xe6</span>, <span class="number">0xe7</span>, <span class="number">0xe8</span>, <span class="number">0xe9</span>, <span class="number">0xea</span>,</span><br><span class="line">				<span class="number">0xf1</span>, <span class="number">0xf2</span>, <span class="number">0xf3</span>, <span class="number">0xf4</span>, <span class="number">0xf5</span>, <span class="number">0xf6</span>, <span class="number">0xf7</span>, <span class="number">0xf8</span>,</span><br><span class="line">				<span class="number">0xf9</span>, <span class="number">0xfa</span>]</span><br><span class="line"></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  ac_huffman_table=[<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">  	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_ac_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">  		ac_huffman_table[standard_ac_values[pos_in_table]]=bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  		pos_in_table+=<span class="number">1</span></span><br><span class="line">  		code_value+=<span class="number">1</span></span><br><span class="line">  	code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#转成float类型</span></span><br><span class="line">  img_data=img_data.astype(np.float64)</span><br><span class="line">  <span class="comment">#存储最后的哈夫曼编码</span></span><br><span class="line">  result=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#分成8*8的块</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(h//<span class="number">8</span>):</span><br><span class="line">  	<span class="keyword">for</span> j <span class="keyword">in</span> range(w//<span class="number">8</span>):</span><br><span class="line">  		block=img_data[i*<span class="number">8</span>:(i+<span class="number">1</span>)*<span class="number">8</span>,j*<span class="number">8</span>:(j+<span class="number">1</span>)*<span class="number">8</span>]</span><br><span class="line">  		block=cv2.dct(block)</span><br><span class="line">  		<span class="comment">#数据量化</span></span><br><span class="line">  		block[:]=np.round(block/Qy)</span><br><span class="line">  		<span class="comment">#把量化后的二维矩阵转成一维数组</span></span><br><span class="line">  		arr=[<span class="number">0</span>]*<span class="number">64</span></span><br><span class="line">  		notnull_num=<span class="number">0</span></span><br><span class="line">  		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  			tmp=int(block[int(k/<span class="number">8</span>)][k%<span class="number">8</span>])</span><br><span class="line">  			arr[ZigZag[k]]=tmp;</span><br><span class="line">  			<span class="comment">#统计arr数组中有多少个非0元素</span></span><br><span class="line">  			<span class="keyword">if</span> tmp!=<span class="number">0</span>:</span><br><span class="line">  				notnull_num+=<span class="number">1</span></span><br><span class="line">  		<span class="comment">#RLE编码</span></span><br><span class="line">  		<span class="comment">#标识连续0的个数</span></span><br><span class="line">  		time=<span class="number">0</span></span><br><span class="line">  		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  			<span class="keyword">if</span> arr[k]==<span class="number">0</span> <span class="keyword">and</span> time&lt;<span class="number">15</span>:</span><br><span class="line">  				time+=<span class="number">1</span></span><br><span class="line">  			<span class="keyword">else</span>:</span><br><span class="line">  				<span class="comment">#BIT编码</span></span><br><span class="line">  				<span class="comment">#处理括号中第二个数</span></span><br><span class="line">  				data=arr[k]</span><br><span class="line">  				data2=bin(np.abs(data))[<span class="number">2</span>:]</span><br><span class="line">  				data1=len(data2)</span><br><span class="line">  				<span class="keyword">if</span> data&lt;<span class="number">0</span>:</span><br><span class="line">  					data2=bin(np.abs(data)^(<span class="number">2</span>**data1<span class="number">-1</span>))[<span class="number">2</span>:].rjust(data1,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  				<span class="keyword">if</span> data==<span class="number">0</span>:</span><br><span class="line">  					data1=<span class="number">0</span></span><br><span class="line">  				<span class="keyword">if</span> arr[k]==<span class="number">0</span>:</span><br><span class="line">  					data2=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  				<span class="comment">#哈夫曼编码，序列化</span></span><br><span class="line">  				<span class="comment">#直流</span></span><br><span class="line">  				<span class="keyword">if</span> k==<span class="number">0</span>:</span><br><span class="line">  					result+=dc_huffman_table[time*<span class="number">16</span>+data1]</span><br><span class="line">  				<span class="keyword">else</span>:</span><br><span class="line">  					result+=ac_huffman_table[time*<span class="number">16</span>+data1]</span><br><span class="line">  				result+=data2</span><br><span class="line">  				time=<span class="number">0</span></span><br><span class="line">  				<span class="comment">#判断是否要添加EOB</span></span><br><span class="line">  				<span class="keyword">if</span> int(arr[k])!=<span class="number">0</span>:</span><br><span class="line">  					notnull_num-=<span class="number">1</span></span><br><span class="line">  					<span class="comment">#AC系数没有非空</span></span><br><span class="line">  					<span class="keyword">if</span> notnull_num==<span class="number">0</span> <span class="keyword">and</span> k&lt;<span class="number">63</span>:</span><br><span class="line">  						<span class="comment">#添加EOB</span></span><br><span class="line">  						result+=<span class="string">&#x27;1010&#x27;</span></span><br><span class="line">  						<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#补足为8的整数倍，以便编码成16进制数据</span></span><br><span class="line">  <span class="keyword">if</span> len(result)%<span class="number">8</span>!=<span class="number">0</span>:</span><br><span class="line">  	result=result.ljust(len(result)+<span class="number">8</span>-len(result)%<span class="number">8</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  result=hex(int(result,<span class="number">2</span>))[<span class="number">2</span>:]</span><br><span class="line">  res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#添加jpeg文件头</span></span><br><span class="line">  <span class="comment">#SOI(文件头),共89个字节</span></span><br><span class="line">  res+=<span class="string">&#x27;FFD8&#x27;</span></span><br><span class="line">  <span class="comment">#APP0图像识别信息</span></span><br><span class="line">  res+=<span class="string">&#x27;FFE000104A46494600010100000100010000&#x27;</span></span><br><span class="line">  <span class="comment">#DQT定义量化表</span></span><br><span class="line">  res+=<span class="string">&#x27;FFDB004300&#x27;</span></span><br><span class="line">  <span class="comment">#64字节的量化表</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  	res+=hex(Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>])[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="comment">#SOF0图像基本信息，13个字节</span></span><br><span class="line">  res+=<span class="string">&#x27;FFC0000B08&#x27;</span></span><br><span class="line">  res+=hex(h)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  res+=hex(w)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  res+=<span class="string">&#x27;01012200&#x27;</span></span><br><span class="line">  <span class="comment">#DHT定义huffman表,33个字节+183</span></span><br><span class="line">  res+=<span class="string">&#x27;FFC4001F0000010501010101010100000000000000&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> standard_dc_values:</span><br><span class="line">    res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  res+=<span class="string">&#x27;FFC400B5100002010303020403050504040000017D&#x27;</span> </span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> standard_ac_values:</span><br><span class="line">  	res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#SOS扫描行开始，10个字节</span></span><br><span class="line">  res+=<span class="string">&#x27;FFDA0008010100003F00&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#压缩的图像数据（一个个扫描行），数据存放顺序是从左到右、从上到下</span></span><br><span class="line">  res+=result</span><br><span class="line">  <span class="comment">#EOI文件尾0</span></span><br><span class="line">  res+=<span class="string">&#x27;FFD9&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">jpeg解压缩</span></span><br><span class="line"><span class="string">img:解压缩的jpeg灰度图像文件</span></span><br><span class="line"><span class="string">return:返回解压缩后的图像原数据，为多维数组形式</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decompress</span>(<span class="params">img</span>):</span></span><br><span class="line">	<span class="comment">#jpeg解码的所有参数都是从编码后的jpeg文件中读取的</span></span><br><span class="line">  <span class="keyword">with</span> open(img,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    img_data=f.read()</span><br><span class="line">  res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> img_data:</span><br><span class="line">    res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>).upper()</span><br><span class="line"></span><br><span class="line">  ZigZag =[</span><br><span class="line">  <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">27</span>,<span class="number">28</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">26</span>,<span class="number">29</span>,<span class="number">42</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">8</span>,<span class="number">12</span>,<span class="number">17</span>,<span class="number">25</span>,<span class="number">30</span>,<span class="number">41</span>,<span class="number">43</span>,</span><br><span class="line">  <span class="number">9</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">24</span>,<span class="number">31</span>,<span class="number">40</span>,<span class="number">44</span>,<span class="number">53</span>,</span><br><span class="line">  <span class="number">10</span>,<span class="number">19</span>,<span class="number">23</span>,<span class="number">32</span>,<span class="number">39</span>,<span class="number">45</span>,<span class="number">52</span>,<span class="number">54</span>,</span><br><span class="line">  <span class="number">20</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">38</span>,<span class="number">46</span>,<span class="number">51</span>,<span class="number">55</span>,<span class="number">60</span>,</span><br><span class="line">  <span class="number">21</span>,<span class="number">34</span>,<span class="number">37</span>,<span class="number">47</span>,<span class="number">50</span>,<span class="number">56</span>,<span class="number">59</span>,<span class="number">61</span>,</span><br><span class="line">  <span class="number">35</span>,<span class="number">36</span>,<span class="number">48</span>,<span class="number">49</span>,<span class="number">57</span>,<span class="number">58</span>,<span class="number">62</span>,<span class="number">63</span>]</span><br><span class="line">  <span class="comment">#获取亮度量化表</span></span><br><span class="line">  Qy=np.zeros((<span class="number">8</span>,<span class="number">8</span>))</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">    Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]=int(res[<span class="number">50</span>+i*<span class="number">2</span>:<span class="number">52</span>+i*<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">  <span class="comment">#获取SOF0图像基本信息，图像的宽高</span></span><br><span class="line">  h=int(res[<span class="number">188</span>:<span class="number">192</span>],<span class="number">16</span>)</span><br><span class="line">  w=int(res[<span class="number">192</span>:<span class="number">196</span>],<span class="number">16</span>)</span><br><span class="line">  <span class="comment">#获取DHT定义huffman表</span></span><br><span class="line">  standard_dc_values=res[<span class="number">246</span>:<span class="number">270</span>]</span><br><span class="line">  standard_dc_nrcodes=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">  standard_ac_values=res[<span class="number">312</span>:<span class="number">636</span>]</span><br><span class="line">  standard_ac_nrcodes=[<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x7d</span>]</span><br><span class="line">  <span class="comment">#生成dc哈夫曼表</span></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  reverse_dc_huffman_table=&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_dc_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">      reverse_dc_huffman_table[bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)]=standard_dc_values[pos_in_table*<span class="number">2</span>:pos_in_table*<span class="number">2</span>+<span class="number">2</span>]</span><br><span class="line">      pos_in_table+=<span class="number">1</span></span><br><span class="line">      code_value+=<span class="number">1</span></span><br><span class="line">    code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line">  <span class="comment">#生成ac哈夫曼表</span></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  reverse_ac_huffman_table=&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_ac_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">      reverse_ac_huffman_table[bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)]=standard_ac_values[pos_in_table*<span class="number">2</span>:pos_in_table*<span class="number">2</span>+<span class="number">2</span>]</span><br><span class="line">      pos_in_table+=<span class="number">1</span></span><br><span class="line">      code_value+=<span class="number">1</span></span><br><span class="line">    code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">#获取压缩的图像数据</span></span><br><span class="line">  result=res[<span class="number">656</span>:<span class="number">-4</span>]</span><br><span class="line">  <span class="comment">#得到哈夫曼编码后的01字符串,注意左边用0进行补齐</span></span><br><span class="line">  result=bin(int(result,<span class="number">16</span>))[<span class="number">2</span>:].rjust(len(result)*<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  img_data=np.zeros((h,w))</span><br><span class="line">  pos=<span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> range(h//<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(w//<span class="number">8</span>):</span><br><span class="line">      <span class="comment">#逆dc哈夫曼编码</span></span><br><span class="line">      <span class="comment">#正向最大匹配</span></span><br><span class="line">      arr=[<span class="number">0</span>]</span><br><span class="line">      <span class="comment">#计算EOB块中0的个数</span></span><br><span class="line">      num=<span class="number">0</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>,<span class="number">2</span>,<span class="number">-1</span>):</span><br><span class="line">        tmp=reverse_dc_huffman_table.get(result[pos:pos+i])</span><br><span class="line">        <span class="comment">#匹配成功</span></span><br><span class="line">        <span class="keyword">if</span>(tmp):</span><br><span class="line">          time=<span class="number">0</span></span><br><span class="line">          data1=int(tmp[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">          pos+=i</span><br><span class="line">          data2=result[pos:pos+data1]</span><br><span class="line">          <span class="keyword">if</span> data2[<span class="number">0</span>]==<span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">            <span class="comment">#负数</span></span><br><span class="line">            data=<span class="number">-1</span>*(int(data2,<span class="number">2</span>)^(<span class="number">2</span>**data1<span class="number">-1</span>))</span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">            data=int(data2,<span class="number">2</span>)</span><br><span class="line">          arr[<span class="number">0</span>]=data</span><br><span class="line">          pos+=data1</span><br><span class="line">          num+=<span class="number">1</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      <span class="comment">#逆ac哈夫曼编码</span></span><br><span class="line">      <span class="keyword">while</span>(num&lt;<span class="number">64</span>):</span><br><span class="line">        <span class="comment">#AC系数编码长度是从16bits到2bits</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>,<span class="number">1</span>,<span class="number">-1</span>):</span><br><span class="line">          tmp=reverse_ac_huffman_table.get(result[pos:pos+i])</span><br><span class="line">          <span class="keyword">if</span>(tmp):</span><br><span class="line">            pos+=i</span><br><span class="line">            <span class="keyword">if</span>(tmp==<span class="string">&#x27;00&#x27;</span>):</span><br><span class="line">              arr+=([<span class="number">0</span>]*(<span class="number">64</span>-num))</span><br><span class="line">              num=<span class="number">64</span></span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            time=int(tmp[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">            data1=int(tmp[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">            data2=result[pos:pos+data1]</span><br><span class="line">            pos+=data1</span><br><span class="line">            <span class="comment">#data2为空，赋值为0，应对(15,0)这种情况</span></span><br><span class="line">            data2=data2 <span class="keyword">if</span> data2 <span class="keyword">else</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> data2[<span class="number">0</span>]==<span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">              <span class="comment">#负数</span></span><br><span class="line">              data=<span class="number">-1</span>*(int(data2,<span class="number">2</span>)^(<span class="number">2</span>**data1<span class="number">-1</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">              data=int(data2,<span class="number">2</span>)</span><br><span class="line">            num+=time+<span class="number">1</span></span><br><span class="line">            <span class="comment">#time个0</span></span><br><span class="line">            arr+=([<span class="number">0</span>]*time)</span><br><span class="line">            <span class="comment">#非零值或最后一个单元0</span></span><br><span class="line">            arr.append(data)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">      <span class="comment">#逆ZigZag扫描,得到block量化块</span></span><br><span class="line">      block=np.zeros((<span class="number">8</span>,<span class="number">8</span>))</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">        block[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]=arr[ZigZag[i]]</span><br><span class="line"></span><br><span class="line">      <span class="comment">#逆量化</span></span><br><span class="line">      block=block*Qy</span><br><span class="line">      <span class="comment">#逆DCT变换</span></span><br><span class="line">      block=cv2.idct(block)</span><br><span class="line">      img_data[j*<span class="number">8</span>:(j+<span class="number">1</span>)*<span class="number">8</span>,k*<span class="number">8</span>:(k+<span class="number">1</span>)*<span class="number">8</span>]=block</span><br><span class="line">  <span class="keyword">return</span> img_data</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="comment">#原始图像路径,灰度图像</span></span><br><span class="line">  img_path=<span class="string">&#x27;./lena.jpg&#x27;</span></span><br><span class="line">  <span class="comment">#读取原始图像,cv2.imread()默认是用color模式读取的，保持原样读取要加上第二个参数-1,即CV_LOAD_IMAGE_GRAYSCALE</span></span><br><span class="line">  <span class="comment">#得到图像原数据流</span></span><br><span class="line">  img_data=cv2.imread(img_path,<span class="number">-1</span>)</span><br><span class="line">  <span class="comment"># 得到压缩后图像数据</span></span><br><span class="line">  img_compress=compress(img_data,<span class="number">50</span>)</span><br><span class="line">  <span class="comment">#存储压缩后的图像</span></span><br><span class="line">  img_compress_path=<span class="string">&#x27;./img_compress.jpg&#x27;</span></span><br><span class="line">  <span class="keyword">with</span> open(img_compress_path,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  	f.write(base64.b16decode(img_compress.upper()))</span><br><span class="line">  <span class="comment">#jpeg图像解压缩测试</span></span><br><span class="line">  img_decompress=decompress(img_compress_path)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">#结果展示</span></span><br><span class="line">  plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]  <span class="comment"># 中文乱码</span></span><br><span class="line">  <span class="comment">#子图1，原始图像</span></span><br><span class="line">  plt.subplot(<span class="number">121</span>)</span><br><span class="line">  <span class="comment">#imshow()对图像进行处理，画出图像，show()进行图像显示</span></span><br><span class="line">  plt.imshow(img_data,cmap=plt.cm.gray)</span><br><span class="line">  plt.title(<span class="string">&#x27;原始图像&#x27;</span>)</span><br><span class="line">  <span class="comment">#不显示坐标轴</span></span><br><span class="line">  plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#子图2，jpeg压缩后解码图像</span></span><br><span class="line">  plt.subplot(<span class="number">122</span>)</span><br><span class="line">  plt.imshow(img_decompress,cmap=plt.cm.gray)</span><br><span class="line">  plt.title(<span class="string">&#x27;jpeg图像&#x27;</span>)</span><br><span class="line">  plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">  plt.show()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h6><p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="lena_jpeg">/lena_jpeg-16386349163471.png)</p>
<p>左图为原始图像，右图是读取左图的数据后进行jpeg压缩后（质量控制为50）的新的jpeg图像。</p>
<h6 id="灰度图像jpeg压缩（修正版）"><a href="#灰度图像jpeg压缩（修正版）" class="headerlink" title="灰度图像jpeg压缩（修正版）"></a>灰度图像jpeg压缩（修正版）</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pyblake2 <span class="keyword">import</span> blake2s</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">jpeg压缩函数</span></span><br><span class="line"><span class="string">data:要压缩的灰度图像数据流</span></span><br><span class="line"><span class="string">quality_scale控制压缩质量(1-99)，默认为50，值越小图像约清晰</span></span><br><span class="line"><span class="string">return:得到压缩后的图像数据，为FFD9开头的jpeg格式字符串</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compress</span>(<span class="params">img_data,quality_scale=<span class="number">50</span></span>):</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#获取图像数据流宽高</span></span><br><span class="line">  h,w=img_data.shape</span><br><span class="line">  <span class="comment">#标准亮度量化表</span></span><br><span class="line">  Qy=np.array([[<span class="number">16</span>,<span class="number">11</span>,<span class="number">10</span>,<span class="number">16</span>,<span class="number">24</span>,<span class="number">40</span>,<span class="number">51</span>,<span class="number">61</span>],</span><br><span class="line">  	[<span class="number">12</span>,<span class="number">12</span>,<span class="number">14</span>,<span class="number">19</span>,<span class="number">26</span>,<span class="number">58</span>,<span class="number">60</span>,<span class="number">55</span>],</span><br><span class="line">  	[<span class="number">14</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">24</span>,<span class="number">40</span>,<span class="number">57</span>,<span class="number">69</span>,<span class="number">56</span>],</span><br><span class="line">  	[<span class="number">14</span>,<span class="number">17</span>,<span class="number">22</span>,<span class="number">29</span>,<span class="number">51</span>,<span class="number">87</span>,<span class="number">80</span>,<span class="number">62</span>],</span><br><span class="line">  	[<span class="number">18</span>,<span class="number">22</span>,<span class="number">37</span>,<span class="number">56</span>,<span class="number">68</span>,<span class="number">109</span>,<span class="number">103</span>,<span class="number">77</span>],</span><br><span class="line">  	[<span class="number">24</span>,<span class="number">35</span>,<span class="number">55</span>,<span class="number">64</span>,<span class="number">81</span>,<span class="number">104</span>,<span class="number">113</span>,<span class="number">92</span>],</span><br><span class="line">  	[<span class="number">49</span>,<span class="number">64</span>,<span class="number">78</span>,<span class="number">87</span>,<span class="number">103</span>,<span class="number">121</span>,<span class="number">120</span>,<span class="number">101</span>],</span><br><span class="line">  	[<span class="number">72</span>,<span class="number">92</span>,<span class="number">95</span>,<span class="number">98</span>,<span class="number">112</span>,<span class="number">100</span>,<span class="number">103</span>,<span class="number">99</span>]],dtype=np.uint8)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">#根据压缩质量重新计算量化表</span></span><br><span class="line">  <span class="keyword">if</span> quality_scale&lt;=<span class="number">0</span>:</span><br><span class="line">  	quality_scale=<span class="number">1</span></span><br><span class="line">  <span class="keyword">elif</span> quality_scale&gt;=<span class="number">100</span>:</span><br><span class="line">  	quality_scale=<span class="number">99</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  	tmp=int((Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]*quality_scale+<span class="number">50</span>)/<span class="number">100</span>)</span><br><span class="line">  	<span class="keyword">if</span> tmp&lt;=<span class="number">0</span>:</span><br><span class="line">  		tmp=<span class="number">1</span></span><br><span class="line">  	<span class="keyword">elif</span> tmp&gt;<span class="number">255</span>:</span><br><span class="line">  		tmp=<span class="number">255</span></span><br><span class="line">  	Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]=tmp</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Qy=np.array([[2,1,1,1,1,1,2,1],</span></span><br><span class="line">  <span class="comment"># 	[1,1,2,2,2,2,2,4],</span></span><br><span class="line">  <span class="comment"># 	[3,2,2,2,2,5,4,4],</span></span><br><span class="line">  <span class="comment"># 	[3,4,6,5,6,6,6,5],</span></span><br><span class="line">  <span class="comment"># 	[6,6,6,7,9,8,6,7],</span></span><br><span class="line">  <span class="comment"># 	[9,7,6,6,8,11,8,9],</span></span><br><span class="line">  <span class="comment"># 	[10,10,10,10,10,6,8,11],</span></span><br><span class="line">  <span class="comment"># 	[12,11,10,12,9,10,10,10]],dtype=np.uint8)</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">#Z字型</span></span><br><span class="line">  ZigZag =[</span><br><span class="line">	<span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">27</span>,<span class="number">28</span>,</span><br><span class="line">	<span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">26</span>,<span class="number">29</span>,<span class="number">42</span>,</span><br><span class="line">	<span class="number">3</span>, <span class="number">8</span>,<span class="number">12</span>,<span class="number">17</span>,<span class="number">25</span>,<span class="number">30</span>,<span class="number">41</span>,<span class="number">43</span>,</span><br><span class="line">	<span class="number">9</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">24</span>,<span class="number">31</span>,<span class="number">40</span>,<span class="number">44</span>,<span class="number">53</span>,</span><br><span class="line">	<span class="number">10</span>,<span class="number">19</span>,<span class="number">23</span>,<span class="number">32</span>,<span class="number">39</span>,<span class="number">45</span>,<span class="number">52</span>,<span class="number">54</span>,</span><br><span class="line">	<span class="number">20</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">38</span>,<span class="number">46</span>,<span class="number">51</span>,<span class="number">55</span>,<span class="number">60</span>,</span><br><span class="line">	<span class="number">21</span>,<span class="number">34</span>,<span class="number">37</span>,<span class="number">47</span>,<span class="number">50</span>,<span class="number">56</span>,<span class="number">59</span>,<span class="number">61</span>,</span><br><span class="line">	<span class="number">35</span>,<span class="number">36</span>,<span class="number">48</span>,<span class="number">49</span>,<span class="number">57</span>,<span class="number">58</span>,<span class="number">62</span>,<span class="number">63</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">#DC哈夫曼编码表</span></span><br><span class="line">  standard_dc_nrcodes=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">  standard_dc_values=[<span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>]</span><br><span class="line">  <span class="comment"># standard_dc_nrcodes=[0, 1,5,1,1,1,1,1,1,0,0,0,0,0,0,0]</span></span><br><span class="line">  <span class="comment"># standard_dc_values=[0,1,2,3,4,5,6,7,8,9,10,11]</span></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  dc_huffman_table=[<span class="number">0</span>]*<span class="number">16</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_dc_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">      dc_huffman_table[standard_dc_values[pos_in_table]]=bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">      <span class="comment"># ac_huffman_table[standard_ac_values[pos_in_table]].length=k</span></span><br><span class="line">      pos_in_table+=<span class="number">1</span></span><br><span class="line">      code_value+=<span class="number">1</span></span><br><span class="line">    code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#AC哈夫曼编码表</span></span><br><span class="line"></span><br><span class="line">  standard_ac_nrcodes=[<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x7d</span>]</span><br><span class="line">  standard_ac_values=[<span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x04</span>, <span class="number">0x11</span>, <span class="number">0x05</span>, <span class="number">0x12</span>,</span><br><span class="line">				<span class="number">0x21</span>, <span class="number">0x31</span>, <span class="number">0x41</span>, <span class="number">0x06</span>, <span class="number">0x13</span>, <span class="number">0x51</span>, <span class="number">0x61</span>, <span class="number">0x07</span>,</span><br><span class="line">				<span class="number">0x22</span>, <span class="number">0x71</span>, <span class="number">0x14</span>, <span class="number">0x32</span>, <span class="number">0x81</span>, <span class="number">0x91</span>, <span class="number">0xa1</span>, <span class="number">0x08</span>,</span><br><span class="line">				<span class="number">0x23</span>, <span class="number">0x42</span>, <span class="number">0xb1</span>, <span class="number">0xc1</span>, <span class="number">0x15</span>, <span class="number">0x52</span>, <span class="number">0xd1</span>, <span class="number">0xf0</span>,</span><br><span class="line">				<span class="number">0x24</span>, <span class="number">0x33</span>, <span class="number">0x62</span>, <span class="number">0x72</span>, <span class="number">0x82</span>, <span class="number">0x09</span>, <span class="number">0x0a</span>, <span class="number">0x16</span>,</span><br><span class="line">				<span class="number">0x17</span>, <span class="number">0x18</span>, <span class="number">0x19</span>, <span class="number">0x1a</span>, <span class="number">0x25</span>, <span class="number">0x26</span>, <span class="number">0x27</span>, <span class="number">0x28</span>,</span><br><span class="line">				<span class="number">0x29</span>, <span class="number">0x2a</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>, <span class="number">0x37</span>, <span class="number">0x38</span>, <span class="number">0x39</span>,</span><br><span class="line">				<span class="number">0x3a</span>, <span class="number">0x43</span>, <span class="number">0x44</span>, <span class="number">0x45</span>, <span class="number">0x46</span>, <span class="number">0x47</span>, <span class="number">0x48</span>, <span class="number">0x49</span>,</span><br><span class="line">				<span class="number">0x4a</span>, <span class="number">0x53</span>, <span class="number">0x54</span>, <span class="number">0x55</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x58</span>, <span class="number">0x59</span>,</span><br><span class="line">				<span class="number">0x5a</span>, <span class="number">0x63</span>, <span class="number">0x64</span>, <span class="number">0x65</span>, <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0x68</span>, <span class="number">0x69</span>,</span><br><span class="line">				<span class="number">0x6a</span>, <span class="number">0x73</span>, <span class="number">0x74</span>, <span class="number">0x75</span>, <span class="number">0x76</span>, <span class="number">0x77</span>, <span class="number">0x78</span>, <span class="number">0x79</span>,</span><br><span class="line">				<span class="number">0x7a</span>, <span class="number">0x83</span>, <span class="number">0x84</span>, <span class="number">0x85</span>, <span class="number">0x86</span>, <span class="number">0x87</span>, <span class="number">0x88</span>, <span class="number">0x89</span>,</span><br><span class="line">				<span class="number">0x8a</span>, <span class="number">0x92</span>, <span class="number">0x93</span>, <span class="number">0x94</span>, <span class="number">0x95</span>, <span class="number">0x96</span>, <span class="number">0x97</span>, <span class="number">0x98</span>,</span><br><span class="line">				<span class="number">0x99</span>, <span class="number">0x9a</span>, <span class="number">0xa2</span>, <span class="number">0xa3</span>, <span class="number">0xa4</span>, <span class="number">0xa5</span>, <span class="number">0xa6</span>, <span class="number">0xa7</span>,</span><br><span class="line">				<span class="number">0xa8</span>, <span class="number">0xa9</span>, <span class="number">0xaa</span>, <span class="number">0xb2</span>, <span class="number">0xb3</span>, <span class="number">0xb4</span>, <span class="number">0xb5</span>, <span class="number">0xb6</span>,</span><br><span class="line">				<span class="number">0xb7</span>, <span class="number">0xb8</span>, <span class="number">0xb9</span>, <span class="number">0xba</span>, <span class="number">0xc2</span>, <span class="number">0xc3</span>, <span class="number">0xc4</span>, <span class="number">0xc5</span>,</span><br><span class="line">				<span class="number">0xc6</span>, <span class="number">0xc7</span>, <span class="number">0xc8</span>, <span class="number">0xc9</span>, <span class="number">0xca</span>, <span class="number">0xd2</span>, <span class="number">0xd3</span>, <span class="number">0xd4</span>,</span><br><span class="line">				<span class="number">0xd5</span>, <span class="number">0xd6</span>, <span class="number">0xd7</span>, <span class="number">0xd8</span>, <span class="number">0xd9</span>, <span class="number">0xda</span>, <span class="number">0xe1</span>, <span class="number">0xe2</span>,</span><br><span class="line">				<span class="number">0xe3</span>, <span class="number">0xe4</span>, <span class="number">0xe5</span>, <span class="number">0xe6</span>, <span class="number">0xe7</span>, <span class="number">0xe8</span>, <span class="number">0xe9</span>, <span class="number">0xea</span>,</span><br><span class="line">				<span class="number">0xf1</span>, <span class="number">0xf2</span>, <span class="number">0xf3</span>, <span class="number">0xf4</span>, <span class="number">0xf5</span>, <span class="number">0xf6</span>, <span class="number">0xf7</span>, <span class="number">0xf8</span>,</span><br><span class="line">				<span class="number">0xf9</span>, <span class="number">0xfa</span>]</span><br><span class="line"></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  ac_huffman_table=[<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">  	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_ac_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">  		ac_huffman_table[standard_ac_values[pos_in_table]]=bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  		pos_in_table+=<span class="number">1</span></span><br><span class="line">  		code_value+=<span class="number">1</span></span><br><span class="line">  	code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line">  <span class="comment">#第一次置乱</span></span><br><span class="line">  <span class="comment">#PWLCM迭代3*w*h次，得到迭代序列ai</span></span><br><span class="line">  a0=<span class="number">0.26280656351622866</span></span><br><span class="line">  p0=<span class="number">0.37542877661550467</span></span><br><span class="line">  ai=[]</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>*w*h):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span>&lt;=a0&lt;p0:</span><br><span class="line">      a0=a0/p0</span><br><span class="line">    <span class="keyword">elif</span> a0&lt;<span class="number">0.5</span>:</span><br><span class="line">      a0=(a0-p0)*(<span class="number">0.5</span>-p0)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      a0=<span class="number">1</span>-a0</span><br><span class="line">    ai.append(a0)</span><br><span class="line">  <span class="comment">#转成float类型</span></span><br><span class="line">  img_data=img_data.astype(np.float64)</span><br><span class="line">  <span class="comment">#存储最后的哈夫曼编码</span></span><br><span class="line">  result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  prev=<span class="number">0</span></span><br><span class="line">  <span class="comment">#分成8*8的块</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(h//<span class="number">8</span>):</span><br><span class="line">  	<span class="keyword">for</span> j <span class="keyword">in</span> range(w//<span class="number">8</span>):</span><br><span class="line">  		block=img_data[i*<span class="number">8</span>:(i+<span class="number">1</span>)*<span class="number">8</span>,j*<span class="number">8</span>:(j+<span class="number">1</span>)*<span class="number">8</span>]</span><br><span class="line">      <span class="comment">#探索块内置乱对压缩效率的影响</span></span><br><span class="line">  		<span class="comment"># print(block)</span></span><br><span class="line">  		<span class="comment"># tmp=block.flatten(order=&#x27;C&#x27;)</span></span><br><span class="line">  		</span><br><span class="line">  		<span class="comment"># aa=ai[(i*8+j)*64:(i*8+j)*64+64]</span></span><br><span class="line">  		<span class="comment"># dic=list(zip(aa,tmp))</span></span><br><span class="line">  		<span class="comment"># dic.sort(key=lambda x:x[0])</span></span><br><span class="line">  		<span class="comment"># tmp=list(list(zip(*dic))[1])</span></span><br><span class="line">  		<span class="comment"># print(tmp)</span></span><br><span class="line">  		<span class="comment"># print(tmp)</span></span><br><span class="line">  		<span class="comment"># block=np.array(tmp).reshape((8,8),order=&#x27;C&#x27;)</span></span><br><span class="line">  		</span><br><span class="line">  		<span class="comment"># print(block)</span></span><br><span class="line">  		<span class="comment"># return</span></span><br><span class="line"></span><br><span class="line">  		<span class="comment"># print(&#x27;原始8*8图像块&#x27;)</span></span><br><span class="line">  		<span class="comment"># print(block)</span></span><br><span class="line">  		block=cv2.dct(block)</span><br><span class="line">  		<span class="comment"># print(&#x27;dct变换后&#x27;)</span></span><br><span class="line">  		<span class="comment"># print(block)</span></span><br><span class="line">        <span class="comment">#数据量化</span></span><br><span class="line">  		block[:]=np.round(block/Qy)</span><br><span class="line">  		<span class="comment"># print(&#x27;量化后&#x27;)</span></span><br><span class="line">  		<span class="comment"># print(block)</span></span><br><span class="line">  		<span class="comment"># return</span></span><br><span class="line">  		<span class="comment">#把量化后的二维矩阵转成一维数组</span></span><br><span class="line">  		arr=[<span class="number">0</span>]*<span class="number">64</span></span><br><span class="line">  		notnull_num=<span class="number">0</span></span><br><span class="line">  		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  			tmp=int(block[int(k/<span class="number">8</span>)][k%<span class="number">8</span>])</span><br><span class="line">  			arr[ZigZag[k]]=tmp;</span><br><span class="line">  			<span class="comment">#统计arr数组中有多少个非0元素</span></span><br><span class="line">  			<span class="keyword">if</span> tmp!=<span class="number">0</span>:</span><br><span class="line">  				notnull_num+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  		<span class="comment"># print(arr)</span></span><br><span class="line">  		<span class="comment"># return 0</span></span><br><span class="line">  		<span class="comment">#RLE编码</span></span><br><span class="line">  		<span class="comment">#标识连续0的个数</span></span><br><span class="line">  		time=<span class="number">0</span></span><br><span class="line">  		<span class="comment"># print(arr)</span></span><br><span class="line">  		<span class="comment">#处理DC</span></span><br><span class="line">  		<span class="keyword">if</span> arr[<span class="number">0</span>]!=<span class="number">0</span>:</span><br><span class="line">  			notnull_num-=<span class="number">1</span></span><br><span class="line">  		<span class="comment"># if i==21 and j==45:</span></span><br><span class="line">  		<span class="comment"># 	print(&#x27;ssfdafdsa&#x27;,notnull_num)</span></span><br><span class="line">  		data=arr[<span class="number">0</span>]-prev</span><br><span class="line">  		data2=bin(np.abs(data))[<span class="number">2</span>:]</span><br><span class="line">  		data1=len(data2)</span><br><span class="line">  		<span class="keyword">if</span> data&lt;<span class="number">0</span>:</span><br><span class="line">  			data2=bin(np.abs(data)^(<span class="number">2</span>**data1<span class="number">-1</span>))[<span class="number">2</span>:].rjust(data1,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  		<span class="keyword">if</span> data==<span class="number">0</span>:</span><br><span class="line">  			data2=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  			data1=<span class="number">0</span></span><br><span class="line">  		result+=dc_huffman_table[data1]</span><br><span class="line">  		<span class="comment"># if i==21 and j==46:</span></span><br><span class="line">  		<span class="comment"># 	print(prev,dc_huffman_table[data1],data2)</span></span><br><span class="line">  		result+=data2</span><br><span class="line">  		prev=arr[<span class="number">0</span>]</span><br><span class="line">  		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">64</span>):</span><br><span class="line">  			<span class="comment">#有可能AC系数全为0 所以要先进行判断</span></span><br><span class="line">  			<span class="keyword">if</span> notnull_num==<span class="number">0</span>:</span><br><span class="line">					<span class="comment">#添加EOB</span></span><br><span class="line">  				result+=<span class="string">&#x27;1010&#x27;</span></span><br><span class="line">  				<span class="keyword">break</span></span><br><span class="line">  			<span class="keyword">if</span> arr[k]==<span class="number">0</span> <span class="keyword">and</span> time&lt;<span class="number">15</span>:</span><br><span class="line">  				time+=<span class="number">1</span></span><br><span class="line">  			<span class="keyword">else</span>:</span><br><span class="line">  				<span class="comment">#BIT编码</span></span><br><span class="line">  				<span class="comment">#处理括号中第二个数</span></span><br><span class="line">  				data=arr[k]</span><br><span class="line">  				data2=bin(np.abs(data))[<span class="number">2</span>:]</span><br><span class="line">  				data1=len(data2)</span><br><span class="line">  				<span class="comment"># print(type(data1))</span></span><br><span class="line">  				<span class="keyword">if</span> data&lt;<span class="number">0</span>:</span><br><span class="line">  					data2=bin(np.abs(data)^(<span class="number">2</span>**data1<span class="number">-1</span>))[<span class="number">2</span>:].rjust(data1,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  				<span class="keyword">if</span> data==<span class="number">0</span>:</span><br><span class="line">  					data1=<span class="number">0</span></span><br><span class="line">  					data2=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  				<span class="comment"># if arr[k]==0:</span></span><br><span class="line">  				<span class="comment"># 	data2=&#x27;&#x27;</span></span><br><span class="line">  				<span class="comment">#哈夫曼编码，序列化</span></span><br><span class="line">  				<span class="comment"># print(type(ac_huffman_table[6]))</span></span><br><span class="line">  				<span class="comment"># return</span></span><br><span class="line">  				result+=ac_huffman_table[time*<span class="number">16</span>+data1]</span><br><span class="line"></span><br><span class="line">  				result+=data2</span><br><span class="line">  				time=<span class="number">0</span></span><br><span class="line">  				<span class="comment">#判断是否要添加EOB</span></span><br><span class="line">  				<span class="keyword">if</span> int(arr[k])!=<span class="number">0</span>:</span><br><span class="line">  					notnull_num-=<span class="number">1</span></span><br><span class="line">  					<span class="comment">#AC系数没有非空</span></span><br><span class="line">  					<span class="comment"># if notnull_num==0 and k&lt;63:</span></span><br><span class="line">  					<span class="comment"># 	#添加EOB</span></span><br><span class="line">  					<span class="comment"># 	result+=&#x27;1010&#x27;</span></span><br><span class="line">  					<span class="comment"># 	break</span></span><br><span class="line">      <span class="comment"># if i==21 and j==46:</span></span><br><span class="line">      <span class="comment">#   print(result)    </span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># print(result)</span></span><br><span class="line">  <span class="comment">#补足为8的整数倍，以便编码成16进制数据</span></span><br><span class="line">  <span class="keyword">if</span> len(result)%<span class="number">8</span>!=<span class="number">0</span>:</span><br><span class="line">  	result=result.ljust(len(result)+<span class="number">8</span>-len(result)%<span class="number">8</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="comment"># print(len(result))</span></span><br><span class="line">  <span class="comment"># print(result[:40])</span></span><br><span class="line">  <span class="comment"># result=hex(int(result,2))[2:]</span></span><br><span class="line">  res_data=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(result),<span class="number">8</span>):</span><br><span class="line">  	temp=int(result[i:i+<span class="number">8</span>],<span class="number">2</span>)</span><br><span class="line">  	res_data+=hex(temp)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>).upper()</span><br><span class="line">  	<span class="keyword">if</span> temp==<span class="number">255</span>:</span><br><span class="line">  		<span class="comment"># print(11111)</span></span><br><span class="line">  		res_data+=<span class="string">&#x27;00&#x27;</span></span><br><span class="line">  <span class="comment"># print(res_data)</span></span><br><span class="line">  <span class="comment"># print(res_data[:10])</span></span><br><span class="line">  <span class="comment"># print(len(res_data))</span></span><br><span class="line">  result=res_data</span><br><span class="line">  <span class="comment"># print(result)</span></span><br><span class="line">  res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#添加jpeg文件头</span></span><br><span class="line">  <span class="comment">#SOI(文件头),共89个字节</span></span><br><span class="line">  res+=<span class="string">&#x27;FFD8&#x27;</span></span><br><span class="line">  <span class="comment">#APP0图像识别信息</span></span><br><span class="line">  res+=<span class="string">&#x27;FFE000104A46494600010100000100010000&#x27;</span></span><br><span class="line">  <span class="comment">#DQT定义量化表</span></span><br><span class="line">  res+=<span class="string">&#x27;FFDB004300&#x27;</span></span><br><span class="line">  <span class="comment">#64字节的量化表</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">  	res+=hex(Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>])[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="comment">#SOF0图像基本信息，13个字节</span></span><br><span class="line">  res+=<span class="string">&#x27;FFC0000B08&#x27;</span></span><br><span class="line">  res+=hex(h)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  res+=hex(w)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="comment"># res+=&#x27;01012200&#x27;</span></span><br><span class="line">  <span class="comment">#采样系数好像都是1</span></span><br><span class="line">  res+=<span class="string">&#x27;01011100&#x27;</span></span><br><span class="line">  <span class="comment">#DHT定义huffman表,33个字节+183</span></span><br><span class="line">  <span class="comment"># res+=&#x27;FFC4001F0000010501010101010100000000000000&#x27;</span></span><br><span class="line">  res+=<span class="string">&#x27;FFC4001F00&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> standard_dc_nrcodes:</span><br><span class="line">    res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> standard_dc_values:</span><br><span class="line">    res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  <span class="comment"># res+=&#x27;FFC400B5100002010303020403050504040000017D&#x27; </span></span><br><span class="line">  res+=<span class="string">&#x27;FFC400B510&#x27;</span> </span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> standard_ac_nrcodes:</span><br><span class="line">  	res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> standard_ac_values:</span><br><span class="line">  	res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#SOS扫描行开始，10个字节</span></span><br><span class="line">  res+=<span class="string">&#x27;FFDA0008010100003F00&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#压缩的图像数据（一个个扫描行），数据存放顺序是从左到右、从上到下</span></span><br><span class="line">  res+=result</span><br><span class="line">  <span class="comment"># print(len(result))</span></span><br><span class="line">  <span class="comment">#EOI文件尾0</span></span><br><span class="line">  res+=<span class="string">&#x27;FFD9&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">jpeg解压缩</span></span><br><span class="line"><span class="string">img:解压缩的jpeg灰度图像文件</span></span><br><span class="line"><span class="string">return:返回解压缩后的图像原数据，为多维数组形式</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decompress</span>(<span class="params">img</span>):</span></span><br><span class="line">	<span class="comment">#jpeg解码的所有参数都是从编码后的jpeg文件中读取的</span></span><br><span class="line">  <span class="keyword">with</span> open(img,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    img_data=f.read()</span><br><span class="line">  res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> img_data:</span><br><span class="line">    res+=hex(i)[<span class="number">2</span>:].rjust(<span class="number">2</span>,<span class="string">&#x27;0&#x27;</span>).upper()</span><br><span class="line"></span><br><span class="line">  ZigZag =[</span><br><span class="line">  <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">27</span>,<span class="number">28</span>,</span><br><span class="line">  <span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">26</span>,<span class="number">29</span>,<span class="number">42</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">8</span>,<span class="number">12</span>,<span class="number">17</span>,<span class="number">25</span>,<span class="number">30</span>,<span class="number">41</span>,<span class="number">43</span>,</span><br><span class="line">  <span class="number">9</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">24</span>,<span class="number">31</span>,<span class="number">40</span>,<span class="number">44</span>,<span class="number">53</span>,</span><br><span class="line">  <span class="number">10</span>,<span class="number">19</span>,<span class="number">23</span>,<span class="number">32</span>,<span class="number">39</span>,<span class="number">45</span>,<span class="number">52</span>,<span class="number">54</span>,</span><br><span class="line">  <span class="number">20</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">38</span>,<span class="number">46</span>,<span class="number">51</span>,<span class="number">55</span>,<span class="number">60</span>,</span><br><span class="line">  <span class="number">21</span>,<span class="number">34</span>,<span class="number">37</span>,<span class="number">47</span>,<span class="number">50</span>,<span class="number">56</span>,<span class="number">59</span>,<span class="number">61</span>,</span><br><span class="line">  <span class="number">35</span>,<span class="number">36</span>,<span class="number">48</span>,<span class="number">49</span>,<span class="number">57</span>,<span class="number">58</span>,<span class="number">62</span>,<span class="number">63</span>]</span><br><span class="line">  <span class="comment">#获取亮度量化表</span></span><br><span class="line">  Qy=np.zeros((<span class="number">8</span>,<span class="number">8</span>))</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">    Qy[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]=int(res[<span class="number">50</span>+i*<span class="number">2</span>:<span class="number">52</span>+i*<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">  <span class="comment">#获取SOF0图像基本信息，图像的宽高</span></span><br><span class="line">  h=int(res[<span class="number">188</span>:<span class="number">192</span>],<span class="number">16</span>)</span><br><span class="line">  w=int(res[<span class="number">192</span>:<span class="number">196</span>],<span class="number">16</span>)</span><br><span class="line">  <span class="comment">#获取DHT定义huffman表</span></span><br><span class="line">  standard_dc_values=res[<span class="number">246</span>:<span class="number">270</span>]</span><br><span class="line">  <span class="comment"># standard_dc_nrcodes=[0, 0, 7, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0]</span></span><br><span class="line">  standard_dc_nrcodes=[<span class="number">0</span>]*<span class="number">16</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">  	standard_dc_nrcodes[i]=int(res[<span class="number">214</span>+i*<span class="number">2</span>:<span class="number">216</span>+i*<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">  standard_ac_values=res[<span class="number">312</span>:<span class="number">636</span>]</span><br><span class="line">  standard_ac_nrcodes=[<span class="number">0</span>]*<span class="number">16</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">  	standard_ac_nrcodes[i]=int(res[<span class="number">280</span>+i*<span class="number">2</span>:<span class="number">282</span>+i*<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">  <span class="comment"># standard_ac_nrcodes=[0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,0x7d]</span></span><br><span class="line">  <span class="comment">#生成dc哈夫曼表</span></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  reverse_dc_huffman_table=&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_dc_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">      reverse_dc_huffman_table[bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)]=standard_dc_values[pos_in_table*<span class="number">2</span>:pos_in_table*<span class="number">2</span>+<span class="number">2</span>]</span><br><span class="line">      pos_in_table+=<span class="number">1</span></span><br><span class="line">      code_value+=<span class="number">1</span></span><br><span class="line">    code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line">  <span class="comment">#生成ac哈夫曼表</span></span><br><span class="line">  pos_in_table = <span class="number">0</span>;</span><br><span class="line">  code_value = <span class="number">0</span>;</span><br><span class="line">  reverse_ac_huffman_table=&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,standard_ac_nrcodes[i<span class="number">-1</span>]+<span class="number">1</span>):</span><br><span class="line">      reverse_ac_huffman_table[bin(code_value)[<span class="number">2</span>:].rjust(i,<span class="string">&#x27;0&#x27;</span>)]=standard_ac_values[pos_in_table*<span class="number">2</span>:pos_in_table*<span class="number">2</span>+<span class="number">2</span>]</span><br><span class="line">      pos_in_table+=<span class="number">1</span></span><br><span class="line">      code_value+=<span class="number">1</span></span><br><span class="line">    code_value &lt;&lt;=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">#获取压缩的图像数据</span></span><br><span class="line">  </span><br><span class="line">  tmp_result=res[<span class="number">656</span>:<span class="number">-4</span>]</span><br><span class="line">  <span class="comment"># print(len(tmp_result))</span></span><br><span class="line">  result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="comment"># for i in range(0,len(tmp_result),2):</span></span><br><span class="line">  i=<span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> i&lt;len(tmp_result):</span><br><span class="line">  	tmp0=tmp_result[i:i+<span class="number">2</span>]</span><br><span class="line">  	result+=tmp0</span><br><span class="line">  	i+=<span class="number">2</span></span><br><span class="line">  	<span class="keyword">if</span>(tmp0==<span class="string">&#x27;FF&#x27;</span>):</span><br><span class="line">  		i+=<span class="number">2</span></span><br><span class="line">  	</span><br><span class="line">  <span class="comment"># result=result.replace(&#x27;FF00&#x27;,&#x27;FF&#x27;)</span></span><br><span class="line">  <span class="comment"># print(len(result)) </span></span><br><span class="line">  <span class="comment"># print(result) </span></span><br><span class="line">  <span class="comment">#得到哈夫曼编码后的01字符串</span></span><br><span class="line">    	<span class="comment"># result=result.ljust(len(result)+8-len(result)%8,&#x27;0&#x27;)</span></span><br><span class="line">  result=bin(int(result,<span class="number">16</span>))[<span class="number">2</span>:].rjust(len(result)*<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># print(result)</span></span><br><span class="line">  <span class="comment"># print(reverse_dc_huffman_table)</span></span><br><span class="line">  img_data=np.zeros((h,w))</span><br><span class="line">  pos=<span class="number">0</span></span><br><span class="line">  prev=<span class="number">0</span></span><br><span class="line">  tt=<span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> range(h//<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(w//<span class="number">8</span>):</span><br><span class="line">      <span class="comment">#逆dc哈夫曼编码</span></span><br><span class="line">      <span class="comment">#正向最大匹配</span></span><br><span class="line">      arr=[<span class="number">0</span>]</span><br><span class="line">      <span class="comment">#计算EOB块中0的个数</span></span><br><span class="line">      num=<span class="number">0</span></span><br><span class="line">      tt=pos</span><br><span class="line">      <span class="comment"># if(j*(w//8)+k==1390):</span></span><br><span class="line">      <span class="comment"># if j==21 and k==45:</span></span><br><span class="line">      <span class="comment">#   print(result[pos:pos+100])</span></span><br><span class="line">      <span class="comment"># if(j==63 and k==60):</span></span><br><span class="line">      <span class="comment"># 	print(result[pos:])</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>,<span class="number">2</span>,<span class="number">-1</span>):</span><br><span class="line">        tmp=reverse_dc_huffman_table.get(result[pos:pos+i])</span><br><span class="line">        <span class="comment">#匹配成功</span></span><br><span class="line">        <span class="keyword">if</span>(tmp):</span><br><span class="line">          pos+=i</span><br><span class="line">          num+=<span class="number">1</span></span><br><span class="line">          <span class="comment">#DC系数为0</span></span><br><span class="line">          <span class="comment"># if j==21 and k==45:</span></span><br><span class="line">          <span class="comment">#   print(tmp,prev)</span></span><br><span class="line">          <span class="keyword">if</span> tmp==<span class="string">&#x27;00&#x27;</span>:</span><br><span class="line">            <span class="comment"># print(reverse_dc_huffman_table.get(result[pos-i:pos]),result[pos-i:pos])</span></span><br><span class="line">            <span class="comment"># print(tmp,11111)</span></span><br><span class="line">            <span class="comment">#是差值编码 差点忘了加上prev</span></span><br><span class="line">            arr[<span class="number">0</span>]=<span class="number">0</span>+prev</span><br><span class="line">            prev=arr[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># pos+=i</span></span><br><span class="line">            <span class="comment"># num+=1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">          time=<span class="number">0</span></span><br><span class="line">          data1=int(tmp[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">          <span class="comment"># pos+=i</span></span><br><span class="line"></span><br><span class="line">          data2=result[pos:pos+data1]</span><br><span class="line">          <span class="comment"># data2=data2 if data2 else &#x27;0&#x27;</span></span><br><span class="line">          <span class="comment"># print(data1,data2)</span></span><br><span class="line">          <span class="comment"># data=int(data2,2)</span></span><br><span class="line">          <span class="keyword">if</span> data2[<span class="number">0</span>]==<span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">              <span class="comment">#负数</span></span><br><span class="line">              data=-(int(data2,<span class="number">2</span>)^(<span class="number">2</span>**data1<span class="number">-1</span>))</span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">            data=int(data2,<span class="number">2</span>)</span><br><span class="line">          arr[<span class="number">0</span>]=data+prev</span><br><span class="line">          prev=arr[<span class="number">0</span>]</span><br><span class="line">          pos+=data1</span><br><span class="line">          <span class="comment"># print(arr[0])</span></span><br><span class="line">          <span class="comment"># num+=1</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      <span class="comment">#逆ac哈夫曼编码</span></span><br><span class="line">      <span class="keyword">while</span>(num&lt;<span class="number">64</span>):</span><br><span class="line">        <span class="comment">#AC系数编码长度是从16bits到2bits</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>,<span class="number">1</span>,<span class="number">-1</span>):</span><br><span class="line">          tmp=reverse_ac_huffman_table.get(result[pos:pos+i])</span><br><span class="line">          <span class="keyword">if</span>(tmp):</span><br><span class="line">            <span class="comment"># if j==21 and k==45:</span></span><br><span class="line">            <span class="comment">#   print(tmp,result[pos:pos+i])</span></span><br><span class="line">            pos+=i</span><br><span class="line">            <span class="keyword">if</span>(tmp==<span class="string">&#x27;00&#x27;</span>):</span><br><span class="line">              arr+=([<span class="number">0</span>]*(<span class="number">64</span>-num))</span><br><span class="line">              num=<span class="number">64</span></span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            time=int(tmp[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">            data1=int(tmp[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">            data2=result[pos:pos+data1]</span><br><span class="line">            pos+=data1</span><br><span class="line">            <span class="comment">#data2为空，赋值为0，应对(15,0)这种情况</span></span><br><span class="line">            data2=data2 <span class="keyword">if</span> data2 <span class="keyword">else</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> data2[<span class="number">0</span>]==<span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">            	<span class="comment"># print(data2,data1)</span></span><br><span class="line">            	<span class="comment">#负数,注意负号和异或运算的优先级</span></span><br><span class="line">            	data=-(int(data2,<span class="number">2</span>)^(<span class="number">2</span>**data1<span class="number">-1</span>))</span><br><span class="line">            	<span class="comment"># print(data)</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">            	data=int(data2,<span class="number">2</span>)</span><br><span class="line">            <span class="comment"># data=int(data2,2)</span></span><br><span class="line">            num+=time+<span class="number">1</span></span><br><span class="line">            <span class="comment">#time个0</span></span><br><span class="line">            arr+=([<span class="number">0</span>]*time)</span><br><span class="line">            <span class="comment">#非零值或最后一个单元0</span></span><br><span class="line">            arr.append(data)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">      <span class="comment"># print(arr)</span></span><br><span class="line">      <span class="comment"># return 0</span></span><br><span class="line">      <span class="comment">#逆ZigZag扫描,得到block量化块</span></span><br><span class="line">      block=np.zeros((<span class="number">8</span>,<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">      <span class="comment"># print(arr)</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">        block[int(i/<span class="number">8</span>)][i%<span class="number">8</span>]=arr[ZigZag[i]]</span><br><span class="line">      <span class="comment">#逆量化</span></span><br><span class="line">      block=block*Qy</span><br><span class="line">      <span class="comment">#逆DCT变换</span></span><br><span class="line">      block=cv2.idct(block)</span><br><span class="line">      img_data[j*<span class="number">8</span>:(j+<span class="number">1</span>)*<span class="number">8</span>,k*<span class="number">8</span>:(k+<span class="number">1</span>)*<span class="number">8</span>]=block</span><br><span class="line">      <span class="comment"># print(j,k)</span></span><br><span class="line">  img_data=img_data.astype(np.uint8)</span><br><span class="line">  <span class="comment"># print(img_data)</span></span><br><span class="line">  <span class="keyword">return</span> img_data</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="comment">#原始图像路径,灰度图像</span></span><br><span class="line">  img_path=<span class="string">&#x27;./lena.jpg&#x27;</span></span><br><span class="line">  <span class="comment">#读取原始图像,cv2.imread()默认是用color模式读取的，保持原样读取要加上第二个参数-1,即CV_LOAD_IMAGE_GRAYSCALE</span></span><br><span class="line">  <span class="comment">#得到图像原数据流</span></span><br><span class="line">  img_data=cv2.imread(img_path,<span class="number">-1</span>)</span><br><span class="line">  cv2.imwrite(<span class="string">&#x27;./jpeg_compress.jpg&#x27;</span>,img_data)</span><br><span class="line">  img0=cv2.imread(<span class="string">&#x27;./jpeg_compress.jpg&#x27;</span>,<span class="number">-1</span>)</span><br><span class="line">  <span class="comment"># data=np.ones((8,8))</span></span><br><span class="line">  <span class="comment"># for i in range(8):</span></span><br><span class="line">  <span class="comment">#   for j in range(8):</span></span><br><span class="line">  <span class="comment">#     data[i][j]=i*j</span></span><br><span class="line">  <span class="comment"># 得到压缩后图像数据</span></span><br><span class="line">  <span class="comment"># img_compress=compress(data,30)</span></span><br><span class="line">  img_compress=compress(img_data,<span class="number">50</span>)</span><br><span class="line">  <span class="comment"># print(img_compress)</span></span><br><span class="line">  test=cv2.imread(<span class="string">&#x27;./lena.bmp&#x27;</span>)</span><br><span class="line">  cv2.imwrite(<span class="string">&#x27;./lena_rgb.jpg&#x27;</span>,test)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#存储压缩后的图像</span></span><br><span class="line">  img_compress_path=<span class="string">&#x27;./img_compress.jpg&#x27;</span></span><br><span class="line">  <span class="keyword">with</span> open(img_compress_path,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  	f.write(base64.b16decode(img_compress.upper()))</span><br><span class="line">  <span class="comment">#jpeg图像解压缩测试</span></span><br><span class="line">  img_decompress=decompress(img_compress_path)</span><br><span class="line">  img1=cv2.imread(<span class="string">&#x27;./img_compress.jpg&#x27;</span>,<span class="number">-1</span>)</span><br><span class="line">  <span class="comment"># print(img1)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#结果展示</span></span><br><span class="line">  plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]  <span class="comment"># 中文乱码</span></span><br><span class="line">  <span class="comment">#子图1，原始图像</span></span><br><span class="line">  plt.subplot(<span class="number">221</span>)</span><br><span class="line">  <span class="comment">#imshow()对图像进行处理，画出图像，show()进行图像显示</span></span><br><span class="line">  plt.imshow(img_data,cmap=plt.cm.gray)</span><br><span class="line">  plt.title(<span class="string">&#x27;原始图像&#x27;</span>)</span><br><span class="line">  <span class="comment">#不显示坐标轴</span></span><br><span class="line">  plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#子图2，自己写的jpeg压缩后解码图像</span></span><br><span class="line">  plt.subplot(<span class="number">222</span>)</span><br><span class="line">  plt.imshow(img_decompress,cmap=plt.cm.gray)</span><br><span class="line">  plt.title(<span class="string">&#x27;自写jpeg图像(自解压)&#x27;</span>)</span><br><span class="line">  plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#子图3，jpeg压缩后解码图像</span></span><br><span class="line">  plt.subplot(<span class="number">223</span>)</span><br><span class="line">  plt.imshow(img0,cmap=plt.cm.gray)</span><br><span class="line">  plt.title(<span class="string">&#x27;官方jpeg图像&#x27;</span>)</span><br><span class="line">  plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#子图3，jpeg压缩后解码图像</span></span><br><span class="line">  plt.subplot(<span class="number">224</span>)</span><br><span class="line">  plt.imshow(img1,cmap=plt.cm.gray)</span><br><span class="line">  plt.title(<span class="string">&#x27;自写jpeg图像(官方解压)&#x27;</span>)</span><br><span class="line">  plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">  plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># print(img_encrypt)</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2021/12/04/JPEG%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3(%E9%99%84python%E5%AE%9E%E7%8E%B0)/JPEG原理详解(附python实现" alt="gray_jpeg">/gray_jpeg.png)</p>
<p>DC系数采用了DPCM差值编码 并且对最后jpeg二进制数据为FF的后面添加了00字节，但仍存在问题，使用官方jpeg解压缩的结果并不太好，后续再看看</p>
<h6 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h6><p>【<a target="_blank" rel="noopener" href="https://z2bns.github.io/2021/05/31/%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E8%BD%AC%E6%8D%A2RGB-YCbCr/">颜色空间转换RGB-&gt;YCbCr</a>】</p>
<p>【<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41137110/article/details/117431046">JPEG图片格式详解</a>】</p>
<p>【<a target="_blank" rel="noopener" href="https://z2bns.github.io/2021/10/27/DCT%E7%A6%BB%E6%95%A3%E4%BD%99%E5%BC%A6%E5%8F%98%E6%8D%A2/">DCT离散余弦变换</a>】</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="Z2BNS 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="Z2BNS 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

	  
	  
	  <div>
		
		  <div>
    
        <div style="text-align:center;color: #ccc;font-size:40px;">------------- THE END! <i class="fa fa-paw"></i> THANKS! -------------</div>
    
</div>

		
	  </div>

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E5%9B%BE%E5%83%8F/" rel="tag"><i class="fa fa-tag"></i> 图像</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/17/Joint-image-compression-and-encryption-based-on-order-8-alternating-transforms/" rel="prev" title="Joint image compression and encryption based on order-8 alternating transforms">
      <i class="fa fa-chevron-left"></i> Joint image compression and encryption based on order-8 alternating transforms
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/07/%E5%9F%BA%E4%BA%8EJPEG%E7%9A%84%E8%81%94%E5%90%88%E5%9B%BE%E5%83%8F%E5%8E%8B%E7%BC%A9%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/" rel="next" title="基于JPEG的联合图像压缩加密算法">
      基于JPEG的联合图像压缩加密算法 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2"><span class="nav-number">2.</span> <span class="nav-text">步骤一：图像分割</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E8%BD%AC%E6%8D%A2RGB-gt-YCbCr"><span class="nav-number">3.</span> <span class="nav-text">步骤二：颜色空间转换RGB-&gt;YCbCr</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E7%A6%BB%E6%95%A3%E4%BD%99%E5%BC%A6%E5%8F%98%E6%8D%A2"><span class="nav-number">4.</span> <span class="nav-text">步骤三：离散余弦变换</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E6%95%B0%E6%8D%AE%E9%87%8F%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">步骤四：数据量化</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A%E5%93%88%E5%A4%AB%E6%9B%BC%E7%BC%96%E7%A0%81"><span class="nav-number">6.</span> <span class="nav-text">步骤五：哈夫曼编码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BD%AC%E8%BD%BD"><span class="nav-number">7.</span> <span class="nav-text">转载</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#python%E5%AE%9E%E7%8E%B0"><span class="nav-number">8.</span> <span class="nav-text">python实现</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#python%E4%BB%A3%E7%A0%81"><span class="nav-number">9.</span> <span class="nav-text">python代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">10.</span> <span class="nav-text">实验结果</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%81%B0%E5%BA%A6%E5%9B%BE%E5%83%8Fjpeg%E5%8E%8B%E7%BC%A9%EF%BC%88%E4%BF%AE%E6%AD%A3%E7%89%88%EF%BC%89"><span class="nav-number">11.</span> <span class="nav-text">灰度图像jpeg压缩（修正版）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">12.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z2BNS"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Z2BNS</p>
  <div class="site-description" itemprop="description">Because like, so love</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">264</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/z2bns/z2bns.github.io" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;z2bns&#x2F;z2bns.github.io" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:vip1234pinyin@163.com" title="E-Mail → mailto:vip1234pinyin@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/qq_41137110" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41137110" rel="noopener" target="_blank">CSDN</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://z2wnb.github.io/" title="https:&#x2F;&#x2F;z2wnb.github.io" rel="noopener" target="_blank">z2wnb</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://zlw00.github.io/" title="https:&#x2F;&#x2F;zlw00.github.io" rel="noopener" target="_blank">zlw00</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.z2bns.com/" title="http:&#x2F;&#x2F;www.z2bns.com" rel="noopener" target="_blank">wordpress</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>  
  

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z2BNS</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">358k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">5:25</span>
</div>


<!-- 添加运行时间 -->
<span id="sitetime"></span>
<script language=javascript>
	function siteTime(){
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* 
		Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
		year - 作为date对象的年份，为4位年份值
		month - 0-11之间的整数，做为date对象的月份
		day - 1-31之间的整数，做为date对象的天数
		hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
		minutes - 0-59之间的整数，做为date对象的分钟数
		seconds - 0-59之间的整数，做为date对象的秒数
		microseconds - 0-999之间的整数，做为date对象的毫秒数
        */
		var t1 = Date.UTC(2020,10,09,04,00,00); //北京时间2020-10-09 12:00:00
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		document.getElementById("sitetime").innerHTML=" 本站已运行"+/*diffYears+" 年 "+*/diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
	}
	siteTime();
</script>

<br/>
<!--访客访问量-->
<div class="powered-by">

    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<i class="fa fa-user-md"></i>
总访问量<span id="busuanzi_value_site_pv"></span>次
<i class="fa fa-eye"></i>
访客数<span id="busuanzi_value_site_uv"></span>人次
</div>
</div>



 
        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'KN0GiB19RNmgIeCSFonTGgzn-gzGzoHsz',
      appKey     : 'MiL8FBp9YnzlJSeHuER1p7Ua',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

  
  <!-- ҳ����С����-->
<script type="text/javascript" src="/js/click-love.js"></script>

<!-- ��̬���� -->

<script color="255,96,47" opacity='0.8' zIndex="-2" count="200" type="text/javascript" src="/js/canvas-nest.min.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":280,"height":480},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
